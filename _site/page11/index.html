
<!DOCTYPE html>
<html language="en"><head>
  <meta charset="utf-8">
  <title>naildrivin5.com - David Bryant Copeland's Website</title>
  <meta name="author" content="David Bryant Copeland">
  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/images/favicons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/images/favicons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/images/favicons/ms-icon-144x144.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  

  
  <meta name="description" content="
  
  
  
    
      
        
        My first iPhone App - Part 5
        
        July 18, 2010
      
      
        
          
            Se...">
  

  
  <link rel="canonical" href="http://naildrivin5.com/page11/index.html">
  <link href="/favicon.png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="naildrivin5.com - David Bryant Copeland's Website" type="application/atom+xml">
  <link href="/css/styles.css" rel="stylesheet">
  <script src="https://use.typekit.net/ylm4zpa.js"></script>
  <script>try{Typekit.load({ async: true });}catch(e){}</script>
            
  <meta name="google-site-verification" content="h_yTpXa6N3ebHj8DYmgX4lIFGHBW1NtGMVHfXuu7i_4" />
</head>
<body>
  <header class="site-header pb2 mb2 center">
    <h1 class="uc ls2 f1"><a href="/">naildrivin5.com</a></h1>
    <h2 class="ls1"><small class="uc h4">Website of</small> David Bryant Copeland</h2>
    <nav>
      <ul>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/">Blog</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/bio">About</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/books">Books</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/talks">Talks</a></li>
      </ul>
      <div style="clear: both"></div>
    </nav>
  </header>
  <main>
    <section>
      <div class="blog-index">
  
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2010/07/18/iphone-app-part-5.html">My first iPhone App - Part 5</a></h1>
        
        <h2 class="f6 mtneg">July 18, 2010</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            <p><em>See <a href="/blog/2010/06/23/iphone-app-part-1.html">Part 1</a>, <a href="/blog/2010/06/27/iphone-app-part-2.html">Part 2</a>, <a href="/blog/2010/06/29/iphone-app-part-3.html">Part 3</a>, and <a href="/blog/2010/07/08/iphone-app-part-4.html">Part 4</a> first</em></p>

<p>I&#39;ve been working on the app more than my recent lack of blog entries indicates.  At this point, I have what could roughly be called a beta version; almost all the features are there, and things seem to be generally working pretty well.  </p>

<h2>User Experience</h2>

<p>The biggest change in the UX is the ability to add tasting notes, date tasted, and location tasted.  This is a new screen accessible from the main entry screen.  The most obvious way to do this in my mind, was a big button at the bottom:</p>

<p><img src="/images/wine_brain_new_wine_5.jpg" alt="New Add Screen"></p>

<p>In designing the new screen, 
the &quot;where tasted&quot; and &quot;when tasted&quot; were straightforward; I used stock controls.  For the tasting notes, I needed a <code>UITextView</code>, which is akin to an HTML <code>TEXTAREA</code>.  The visual appearance of this control is pretty lacking compared to the <code>UITextField</code>; there is no nice beveled edge, no rounded corners, and no placeholder text.  I really just wanted a multi-line field much like the <code>UITextField</code>, but there is nothing available to create that.</p>

<p>So, I hacked something together.</p>

<p>An option for the <code>UITextField</code>&#39;s appearance is to have a beveled edge with square corners.  In this configuration, you can adjust the height of the text field.  So, I placed such a field on the screen and sized it about the size of my tasting notes field and made the background color white.  I then put the tasting notes field on top of it, with a clear background color, and, well, it looked pretty good:</p>

<p><img src="/images/wine_brain_new_wine_details.jpg" alt="Details Screen"></p>

<p>I then implemented some <code>UITextViewDelegate</code> methods to give the apperance of placeholder text:</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">textViewShouldBeginEditing:</span><span class="p">(</span><span class="bp">UITextView</span> <span class="o">*</span><span class="p">)</span><span class="nv">textView</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="nl">isEqualToString</span><span class="p">:</span><span class="n">DEFAULT_TASTING_NOTES_TEXT</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">@&quot;&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">textViewDidEndEditing:</span><span class="p">(</span><span class="bp">UITextView</span> <span class="o">*</span><span class="p">)</span><span class="nv">textView</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="n">length</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">DEFAULT_TASTING_NOTES_TEXT</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>I considered using some third-party controls that mimic this behavior, but didn&#39;t want to get side-tracked adding new frameworks to my app at this point.</p>

<h2>User Testing</h2>

<p>Once I had this, I handed my phone to Amy for some more user testing; She brought up a few obvious things that I had completely internalized and begun ignoring:</p>

<ul>
<li>Clicking &quot;Save&quot; on the details screen brought you back to the &quot;new wine&quot; screen, instead of just saving and bringing you back to the top.  A minor but obvious annoyance.</li>
<li>She kept tapping on the &quot;Choose Varietal&quot; text field, thinking that would bring up the varietal chooser, instead of clicking the much smaller blue &quot;disclosure&quot; button</li>
<li>She was a bit sad that the wines we had entered in the app would not be available on our shared Google Spreadsheet</li>
</ul>

<p>To smooth the navigation after saving, I used a stock feature of the <code>UINavigationController</code> to &quot;pop&quot; more than once up the chain.  Since my design of the details screen used Apple&#39;s delegate pattern (essentially, the &quot;add new wine&quot; view controller was the delegate to the details view&#39;s lifecycle; when you click &quot;Save&quot; on the detail view, it triggers a callback in the &quot;add new wine&quot; view controller; the perfect place to save before the detail view controller popped back two screens).</p>

<p>The problem with the &quot;Choose Varietal&quot; control had bugged me, too, but I got used to it and didn&#39;t think about it.  The solution was very simple, though hacky.  I placed a clear button on top of the field the exact size of the field and had it trigger the same action as the blue disclosure button.  Problem solved.</p>

<p>As to maintaining the list up on Google Docs, I think I may need to implement this sooner rather than later; I think it&#39;s important to be able to get your data out of an application, and Google Docs is a reasonably user-friendly way to do it (as opposed to emailing some CSV file).  </p>

<h2>Other Random Bits</h2>

<p>I still didn&#39;t get around to setting up iCuke for testing; I really should because I don&#39;t know what missing <code>retain</code> calls might be lurking.  I also finally created an icon, using a picture I took in Napa.  Not sure I like it, but it beats the white blob:</p>

<p><img src="/images/wine_brain_icon.png" alt="Icon"></p>

<p>(Taken from <a href="http://www.flickr.com/photos/davetron5000/3805675435/">my original</a>).</p>

<p>Finally, the app no longer starts up on the actual device.  A seemingly serious problem that I assume would be remedied by a re-install from scratch, however I have a few wines that I&#39;ve added and don&#39;t particularly wanted to lose them.  Not sure how I could gain access to the SQL database to get them out, but I&#39;m currently downloading the 4.0.1 update for my phone and the 2+ GB SDK update (!).</p>

<p><em>As a followup, I had to re-install the application from scratch, though I was able to access the SQLite database from an iTunes backup.  I <em>really</em> need to implement a quicker backup/export mechanism...</em></p>

          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2010/07/08/iphone-app-part-4.html">My first iPhone App - Part 4</a></h1>
        
        <h2 class="f6 mtneg">July 08, 2010</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            <p><em>See <a href="/blog/2010/06/23/iphone-app-part-1.html">Part 1</a>, <a href="/blog/2010/06/27/iphone-app-part-2.html">Part 2</a>, and <a href="/blog/2010/06/29/iphone-app-part-3.html">Part 3</a> first</em></p>

<p>The past week was spent trying to understand the best way to expand my application&#39;s features without have a ton of duplicated code or UI.
It was also a learning experience on Core Data.  Thankfully, <a href="http://www.stackoverflow.com">Stackoverflow</a> and its amazing contributers were very helpful.</p>

<h2>Core Data Blunders</h2>

<p>It started as I made my first foray into implementing the search screen (i.e. the home screen of my app):</p>

<p><img src="/images/wine_brain_homescreen.jpg" alt="Home Screen"></p>

<p>Three of the searches (most recent wines, wines by rating, and all wines) end up doing the same thing more or less: Query for some data, sort it a certain way, and show it in a <code>UITableView</code>.  I ended up creating a custom table cell view and I wanted all three to use it:</p>

<p><img src="/images/wine_brain_custom_cell.jpg" alt="Custom Cell"></p>

<p>Access to Core Data-provided entities is done through objects of the class <code>NSFetchedResultsController</code>, which takes what amounts to a database query and provides many ways of accessing the results, including caching, callbacks, and iteration.  When using a table view, you typically have your view controller handle callbacks for this class, which allows the table to update itself when items are added, removes, or changed.  All of this boilerplate is given to you at the start of the project.  So far so good.</p>

<p>My plan was to create additional <code>NSFetchedResultsController</code> instances inside my table view controller class and then switch between them.  A fine idea that lead that numerous random difficult-to-reproduce crashes.</p>

<p>It turns out the basic idea of what I was doing was good, but my implementation exposed a sore lack of understanding of how all this stuff fit together.  I&#39;m still not sure I fully grasp it (and wish the book I bought had a bit of a deeper dive into Core Data), but after some more reasoning, I got around it.  Essentially, leaving the unused <code>NSFetchedResultsController</code> instances connected to my table view <em>and</em> having caching turned on <em>and</em> not properly reloading data when switching searches created a situation where they were all pretty confused about the underlying state of the database.</p>

<p>With some judicious management of these instances, as well as disabling caching, I now have a fully-functional &quot;Recent Wines&quot;, &quot;Wines By Rating&quot; and fancy indexed &quot;All Wines&quot; view (index meaning I can jump to wines by letter, a la the Contacts application).</p>

<p>Unfortunately, the result of turning off caching is that it takes a noticable blip of time to summon any of these views.  I may just come full circle and end up with three different <code>UITableViewController</code> instances and NIBs just so I can leave Caching on.</p>

<h2>User Experience</h2>

<p>Once I had gotten back to a stable app, I loaded it up on my phone and headed into the field.  A few nights ago, Amy and I ended up at one of our favorite restaurants/wine bars in DC, <a href="http://www.proofdc.com">Proof</a>.  We&#39;ve been there several times, and many of their wines-by-the-glass are in the Wine Brain.  While they rotate their selections, I was curious as to what I&#39;d had there previously.  Unfortunately, I had yet to implement the search-by-location feature :)  Combing through the &quot;All Wines&quot; view was a bit frustrating.  This made obvious several features that are now on the top of my list (some planned previously, some not):</p>

<ul>
<li>Find wines by location</li>
<li>Actually <em>entering</em> the location at which I had a wine</li>
<li>Location-aware assistance of location (e.g. &quot;Are you at Proof?  Here&#39;s what you&#39;ve had there...&quot;)</li>
<li>Ability to text-search the &quot;all wines&quot; list</li>
</ul>

<p>The good news is that my cursory reading of my book and the API docs indicates that these things are going to be <em>very</em> easy to implement.</p>

<h2>Objective-C</h2>

<p>There&#39;s a lot to like about Objective-C, and a lot to dislike.  Even though the handling of multiple arguments is a bit strange, I find it actually results in fairly readable code.  It feels very Apple; different, but usable.  Even though it&#39;s a lot to type out something like:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">NSString *stripped = [canonicalName stringByTrimmingCharactersInSet:
                       [NSCharacterSet whitespaceAndNewlineCharacterSet]];
</code></pre></div>
<p>It <em>is</em> pretty readable, regardless of what programming language you are coming from.  That being said, stack traces and error messages on crashes are nigh-useless, and the overall testability of iPhone apps is pretty behind the times.  This months <a href="http://pragprog.com/magazines">issue of Prag Prog&#39;s magazine</a> has an interesting article on <a href="http://github.com/unboxed/icuke">iCuke</a>, which I look forward to trying out.  I&#39;ve resulted to keeping a text file of test cases that I have to manually run through to make sure I haven&#39;t broken anything, and it feels, well, 1997.  The rumours of a Apple&#39;s switch to Ruby are too good to be true, but one can always dream.</p>

<p><em>Continued in <a href="/blog/2010/07/18/iphone-app-part-5.html">Part 5</a></em></p>

          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2010/06/29/iphone-app-part-3.html">My first iPhone App - Part 3</a></h1>
        
        <h2 class="f6 mtneg">June 29, 2010</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            <p><em>See <a href="/blog/2010/06/27/iphone-app-part-2.html">Part 1</a> and <a href="/blog/2010/06/27/iphone-app-part-2.html">Part 2</a> first</em></p>

<p>Just a quick update for tonight.  I&#39;m starting to get the hang of how the user interface elements I create in Interface Builder get hooked up and become available in code.  It&#39;s a bit odd and not terribly intuitive, but it&#39;s starting to make a <em>bit</em> more sense.  Under the covers there&#39;s some sort of dependency injection going on (even if Apple doesn&#39;t call it that) that smells of Spring-style magic; objects get created for me and populated if I do the right thing.</p>

<p>At any rate, I decided that, before making any more changes, I needed to get a reasonable data set into the app.  I spent two painful hours exporting my Google Doc Wine Brain into CSV and parsing it with Objective-C, mapping it to my Core Data model objects.  In the end, I was successful, but, WOW, what a pain compared to Ruby or Perl.  </p>

<p>Seeing this large set of data on the home screen was very motivational to start working on a drill-down/search interface, as you can see here:</p>

<p><img src="/images/wine_brain_all_wines.jpg" alt="All Wines List"></p>

<p>Before delving into my new homescreen, I decided to work up a better color scheme that was more &quot;wine-like&quot;.  I&#39;m not a big fan of apps that have fancy graphics and obscure the idiomatic iPhone UI, but a bit of a color splash would go a long way (and, not to mention, be well within my graphic design skill level).  In addition, more user testing (via Amy once again) revealed that the rating control needed a much starker contrast between the selected and unselected choices.  There isn&#39;t much I have control over via the API for this, so I chose an alternate style of <code>UISegmentedControl</code> that used the &quot;iPhone blue&quot; for the selected state.  I think it works OK with the color scheme, though I&#39;d prefer the &quot;merlot red&quot; that I chose for the nav bar and wine type:</p>

<p><img src="/images/wine_brain_new_wine_4.jpg" alt="Colorrific New Wine Screen"></p>

<p>I&#39;m starting to think that my desire to have wine entry confined to one screen might not pan out.  The &quot;slot-machine&quot; control will become more and more unusable as more varietals are added, and there&#39;s really no way to even <em>add</em> a new varietal here.  I think I may have to go with the drill-down method where by I push another table view onto the stack to select (and possibly add) a varietal.  For another day.</p>

<p>Lastly, I took a stab at a better home screen:</p>

<p><img src="/images/wine_brain_homescreen.jpg" alt="Home Screen"></p>

<p>This pretty-well represents the ways I <em>think</em> I&#39;d want to navigate the data.  Time will tell once I implement these searches, but this seems like a reasonable start.</p>

<p>I also have to say that, despite Objective-C&#39;s overall wackiness, it was pretty easy to put this together and have the &quot;Add New Wine&quot; button bring up the &quot;Add Wine&quot; screen and to have the &quot;All Wines&quot; button navigate to the old home screen.  Apple has done a reasonable job of making it easy to make an idiomatic, normal-looking iPhone app.</p>

<p><em>Continued in <a href="/blog/2010/07/08/iphone-app-part-4.html">Part 4</a>, and <a href="/blog/2010/07/18/iphone-app-part-5.html">Part 5</a></em></p>

          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2010/06/27/iphone-app-part-2.html">My first iPhone App - Part 2</a></h1>
        
        <h2 class="f6 mtneg">June 27, 2010</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            <p><em>See <a href="/blog/2010/06/23/iphone-app-part-1.html">Part 1</a> first</em></p>

<p>For the past several days I&#39;ve had the app on my phone and used it to enter in wines to see how the UI was working.  Yesterday, I integrated
Core Data (Apple&#39;s Object/Relational Mapper (ORM), for lack of a better description) so that I could actually <em>save</em> some data.  I discovered some nuances to using Core Data, as well as a refinement in the UI.</p>

<h2>UI</h2>

<p>Last night, I had both my girlfriend Amy and my good friend Clay (who is also reasonably into wine) play around with the &quot;new wine&quot; screen.  Neither have an iPhone, and there were a few obvious problems:</p>

<ul>
<li>They were very unaccustomed to the &quot;Done&quot; button being in the upper-right corner, as well as the &quot;slot-machine&quot; control</li>
<li>Both had trouble with the &quot;Wine Name&quot; concept</li>
<li>Both had trouble dismissing the keyboard</li>
<li>Clay thought he was entering search terms and not a new Wine</li>
</ul>

<p>Later that evening, I had a glass of wine at a bar and entered it into my app.  Up until this point, I was just typing in wines I knew about, so this was the first &quot;real use&quot; of the app in the field.  I quickly realized that the &quot;Wine Name&quot; concept, while important, was too vague and confusing to be the first field you enter.  Most wines are known by the vineyard and some don&#39;t even have proper names or appellations.  So, I swapped the fields and added some examples in the placeholder text:</p>

<p><img src="/images/wine_brain_new_wine_comparison.jpg" alt="Comparison"></p>

<p>I also added a title to indicate that this screen is for adding a new wine.  Finally, I used the <a href="http://stackoverflow.com/questions/804563/how-to-hide-the-keyboard-when-empty-area-is-touched-on-iphone">background button trick</a> along with some events on the rating and type controls to dismiss the keyboard if you tap anywhere outside of a text field.</p>

<p>This feels much cleaner and flows a bit better.  While varietal is probably the third most important thing (at least for New World wines), the slot-machine control would be awkwardly placed right below the vineyard/vintage text fields, so I left it where it was.</p>

<p>As to Clay and Amy&#39;s confusion over some idiomatic iPhone design choices, I&#39;m not worrying about them a whole lot; a typical iPhone user will understand what&#39;s going on (I hope :).</p>

<h2>Core Data</h2>

<p>Backing all this is Apple&#39;s Core Data, which grew out of the <a href="http://en.wikipedia.org/wiki/Enterprise_Objects_Framework">Enterprise Objects Framework</a> (and was, incidentally, my first exposure to an ORM way back in 1998), is the simplest and most idiomatic way to store and manage data on the iPhone.  As with Interface Builder, you create the model visually, using a simplistic data modelling tool.  I set up the bare bones of my data model and generated the classes.</p>

<p><img src="/images/wine_brain_data_model.jpg" alt="Data Model"></p>

<p>The first problem I ran into was in changing the model after the database had been created on the device.  Core Data doesn&#39;t migrate your model for you by default.  I ended up starting over with a &quot;versioned&quot; model and implementing their default migration.  This will probably work for simple changes, but for more complex changes, it looks like it&#39;s somewhat difficult to migrate the model.  An unfortunate reason to do some Big Design Up Front.</p>

<p>My next problem was initializing reference data.  In my case, I wanted the list of varietals as well as the list of wine types (e.g. &quot;red&quot;, &quot;white&quot;) to be in the database and managed by Core Data.  I ended up creating an array of the values inside the app and then checking the database for their existence, adding them if they were missing.  It&#39;s a bit cheesy, but I can extract the lists to plist files later.  It <em>did</em> give me a chance to play with Objective-C&#39;s blocks feature.  I needed to map my list of <code>Varietal</code> objects to a list of strings, so I could compare that list against my default list.  While <code>NSArray</code> doesn&#39;t provide a map function, it does provide the equivalent of Ruby&#39;s <code>each</code> or Scala&#39;s <code>foreach</code>.  In true Apple/Objective-C style, it&#39;s called <code>enumerateObjectsUsingBlock</code> :)</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="bp">NSMutableArray</span> <span class="o">*</span><span class="n">strings</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableArray</span> <span class="nl">arrayWithCapacity</span><span class="p">:[</span><span class="n">array</span> <span class="n">count</span><span class="p">]];</span>
<span class="p">[</span><span class="n">array</span> <span class="nl">enumerateObjectsUsingBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">id</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">NSUInteger</span> <span class="n">i</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">strings</span> <span class="nl">addObject</span><span class="p">:[</span><span class="n">obj</span> <span class="nl">valueForKey</span><span class="p">:</span><span class="s">@&quot;name&quot;</span><span class="p">]];</span>
<span class="p">}];</span></code></pre></div>

<p>The <code>stop</code> pointer is an out-only variable that you set to YES to allow for an early exit from the loop.  I&#39;m glad they&#39;ve adopted this functional style; I forsee explicit loops becoming just as quaint as GOTOs in the near future.</p>

<p>One thing bugged me about this process, however.  I had these generated classes and it wasn&#39;t clear how to add my own methods to them without losing the code every time I re-generated my model.  Enter <a href="http://github.com/rentzsch/mogenerator">mogenerator</a>.  This provides a more sophisticated bit of code generation, givng you two classes for each model: one for machines (i.e. for Core Data to manage) and a subclass for people (to which I can add custom methods).  Perfect!  I wasn&#39;t able to incorporate it into XCode, but I&#39;m happy running in on the command line as needed for now.</p>

<h2>Random Bits</h2>

<p>I spent more time than I would&#39;ve liked tracking down a nasty bug where every attempt to convert a string to a number (for the wine vintage year) resulted in a <code>nil</code> number.  It turns out I was confused about when some object lifecycle methods were being called and my pointer to an <code>NSNumberFormatter</code> was, in fact, pointing to <code>nil</code>.  Unlike Java, where you&#39;d get a <code>NullPointerException</code>, or C, where you&#39;d get a core dump, it seems Objective-C just returns <code>nil</code> and doesn&#39;t even issue a warning.  Very strange.  Once I realized that, the solution was obvious.</p>

<p>I&#39;m still not 100% sure I&#39;m structuring my code properly, but Stack Overflow&#39;s stalwart iPhone SDK answerers have been <em>incredibly</em> helpful in pointing me in the right direction.</p>

<h2>Next Steps</h2>

<p>Now that I&#39;ve got the ability to save and retrieve data, the next step is to start looking to browsing, viewing, and editing the database.  I think the domain is restricted enough that I can use the iPhone&#39;s idiomatic drill-down table navigation to filter the database.</p>

<p>Continued in <a href="/blog/2010/06/29/iphone-app-part-3.html">Part 3</a>, <a href="/blog/2010/07/08/iphone-app-part-4.html">Part 4</a>, and <a href="/blog/2010/07/18/iphone-app-part-5.html">Part 5</a></p>

          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2010/06/23/iphone-app-part-1.html">My first iPhone App - Part 1</a></h1>
        
        <h2 class="f6 mtneg">June 23, 2010</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            <h2>Background</h2>

<p>Last year, I spent most of my free time becoming familiar with Ruby, Rails, and Scala.  I&#39;m by no means an expert, but I&#39;m trying
to follow the advice of the <a href="http://www.pragprog.com">Pragmatic Programmers</a> and learn a new language/system every year.  This year, it&#39;s
going to be the iPhone API and Objective-C.  I coded some WebObjects applications in Objective-C many years ago, so the language
isn&#39;t totally unfamiliar, but the iPhone SDK, obviously, is.  After working my way through the first several
chapters of the <a href="http://pragprog.com/titles/amiphd/iphone-sdk-development">Dudney and Adamson&#39;s &quot;iPhone SDK Development&quot;</a> book, I decided I was ready to try my first real app.</p>

<h2>First App</h2>

<p>My girlfriend and I enjoy wine, but are largely novices.  On a trip to Napa we started writing down the wines we&#39;d tried and keeping personal
ratings of them.  The idea being twofold: try to remember good wines/avoid bad ones, and try to hone in on what our tastes are.  There are
so many wines and so many flavors and smells, it&#39;s just impossible to keep in your head.  So, I created a Google Spreadsheet and a form to allow us to enter wines on the go, via our smart phones.  The Goolge Docs form is less than usable, and this seems like the perfect job for a native iPhone app.</p>

<h3>User Experience</h3>

<p>Aside from learning the ins and outs of the SDK, another main goal is focus on making a highly-usable application (at least for myself and my girlfriend).  So, before diving into Core Data and modelling the domain, my first version of the applicaton simply presents the &quot;add a new wine&quot; screen.  This will be the screen I spend the most time in, and it&#39;s important to make it fast and easy.</p>

<p>The Google Spreadsheet currently collects:</p>

<ul>
<li>Wine Name</li>
<li>Vineyard</li>
<li>Vintage (year)</li>
<li>Varietal</li>
<li>Type (e.g. red/white)</li>
<li>Where we had</li>
<li>When we had</li>
<li>My rating</li>
<li>Her rating</li>
<li>Tasting Notes</li>
</ul>

<p>That&#39;s obviously too much for one iphone screen, and, if I&#39;m entering something in a hurry, I might not have time to go through all that.  Further, I think adding multiple ratings makes things a bit confusing, so I focussed my screen on the identifying characteristics (name/vineyard/vintage), the rating, and the type:</p>

<p><img src="/images/wine_brain_new_wine_1.jpg" alt="First Attempt"></p>

<p>As you can see, I tried to fit the &quot;where&quot; on the bottom, as well as a &quot;enter more information&quot; button.  After loading this on the phone, it was just not working out, plus I was missing the varietal, which is fairly important (at least to me).  </p>

<p>My next attempt simply ignores the &quot;add more&quot; concept, and, by using the segmented control, I was able to fit the type into a more compact area, while including the varietal as a &quot;slot-machine&quot;/picker.</p>

<p><img src="/images/wine_brain_new_wine_2.jpg" alt="Second Attempt"></p>

<p>My plan is to load this onto the phone and try using it the next few times I&#39;m out.  I figure I can do without the tasting notes or location if it keeps the UI simple</p>

<h3>The Code</h3>

<p>Objective-C and XCode are a whole different world from Java or Ruby.  First thing that bit me is the memory management.  I was familiar
with the rules (or so I thought).  Basically, if you call a method like &quot;copyXXX&quot; or &quot;initXXX&quot; to create a new object, you must
<code>release</code> it when you are done with it.  If you get access to an object through any other means, you should <em>not</em> release it.</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="c1">// my class has an NSArray called varietals that I&#39;m initializing here</span>
<span class="n">varietals</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSArray</span> <span class="nl">arrayWithObjects</span><span class="p">:</span>
                  <span class="s">@&quot;Barbera&quot;</span><span class="p">,</span>
                  <span class="s">@&quot;Cabernet Franc&quot;</span><span class="p">,</span>
                  <span class="c1">// snip</span>
                  <span class="s">@&quot;Zinfandel&quot;</span><span class="p">,</span>
                  <span class="s">@&quot;Other&quot;</span><span class="p">,</span>
                  <span class="nb">nil</span><span class="p">];</span></code></pre></div>

<p>Since I&#39;m <em>not</em> calling an &quot;init&quot; style method, I figured I didn&#39;t need to release it in <code>dealloc</code>. For some reason, this made me decide that I didn&#39;t need to <code>retain</code> it.  This caused my first crash and trip through the debugger to figure out what in the heck is going on.</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="c1">// my class has an NSArray called varietals that I&#39;m initializing here</span>
<span class="n">varietals</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSArray</span> <span class="nl">arrayWithObjects</span><span class="p">:</span>
                  <span class="s">@&quot;Barbera&quot;</span><span class="p">,</span>
                  <span class="s">@&quot;Cabernet Franc&quot;</span><span class="p">,</span>
                  <span class="c1">// snip</span>
                  <span class="s">@&quot;Zinfandel&quot;</span><span class="p">,</span>
                  <span class="s">@&quot;Other&quot;</span><span class="p">,</span>
                  <span class="nb">nil</span><span class="p">]</span> <span class="k">retain</span><span class="p">];</span></code></pre></div>

<p>Since I needed <code>varietals</code> to survive the method where I was initializing it, I had to <code>retain</code> it.</p>

<h3>Other struggles</h3>

<p>Interestingly, laying out the UI and getting that hooked up isn&#39;t too bad; the thing I&#39;m having the most trouble with is figuring out what is the &quot;unsurprising&quot; way of doing things; tutorial code from books is rarely very well written; it&#39;s usually done in a certain way to make concepts clear, but I haven&#39;t yet found a definitive &quot;here&#39;s how you organize your code&quot; or &quot;iPhone best practices&quot; that seems relatively comprehensive.</p>

<p>At any rate, I figure if I can get the UX to be reasonably good, the rest should sort itself out.</p>

<p>I&#39;ll continue posting about my progress here on my blog.  If I can get the app polished and working, my girlfriend might demand and Android version.  Would be interesting to compare the two paradigms (especially since Android is all Java, which has been my bread-and-butter for many years).</p>

<p><a href="/blog/2010/06/27/iphone-app-part-2.html">Continued in Part 2</a>, <a href="/blog/2010/06/29/iphone-app-part-3.html">Part 3</a>, <a href="/blog/2010/07/08/iphone-app-part-4.html">Part 4</a>, and <a href="/blog/2010/07/18/iphone-app-part-5.html">Part 5</a></p>

          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2010/06/14/in-defense-of-vi.html">In defense of vi</a></h1>
        
        <h2 class="f6 mtneg">June 14, 2010</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            <p>Sadly, I was unable to attend <a href="http://www.railsconf.org">RailsConf</a> this year.  It was in Baltimore, and it would&#39;ve been a lot of fun, but it just wasn&#39;t in the cards.  One of the great things about RailsConf is that the videos are posted online very quickly and are always of high quality.  While I always like hearing <a href="http://www.youtube.com/watch?v=b0iKYRKtAsA">DHH</a> speak, I try to never miss one of <a href="http://www.twitter.com/unclebobmartin">Uncle Bob Martin</a>, author of the must-go-read-this-right-now <a href="http://www.amazon.com/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882/ref=sr_1_1?ie=UTF8&amp;s=books&amp;qid=1276567370&amp;sr=8-1">Clean Code</a>.</p>

<p>This year, he gave an <a href="http://www.youtube.com/watch?v=mslMLp5bQD0">awesome talk</a> on the (lack of) innovation in software development.  He pointed out that we were still writing the same type of code now as we were 40 years ago.  In one part, he asks the crowd what editor they use (knowing full well most will say <a href="http://www.vim.org">vim</a>).  He then proceeds to make light of the audience for using a 19-year-old editor based on a 34-year-old editor.  While his criticism is brief, I think it speaks more to the sorry state of text editing than to the developers (like me) who are &quot;still&quot; using vim.</p>

<p>I&#39;m sure that unclebob is one of the more advanced IDE users, but it just <em>pains</em> me watching my co-workers meander through their code, selecting things with the mouse, and deleting long swaths of text by just hitting the delete key a lot. </p>

<p>While an IDE is great for learning a new environment (especially one as pedantic and verbose as Java or Objective-C), the editing capabilities are counter-intuitive and degenerate.  vim may be hard on the newbie, but it&#39;s intuitive and logical.  When you understand the &quot;zen&quot; of vim, you can fly through your code, playing it like a musical instrument.  It <em>affords</em> muscle memory and allows sophisticated chaining of movement, intent, and action.  You can <em>see</em> what you want to accomplish and your hands make it so, all without reaching for a mouse, cursoring, using the delete key, or contorting your hand with some awful combination of key modifiers.</p>

<p>Think of it as a piano; it&#39;s a very simple base of simple sounds and actions that, when chained together, can be used to make beautiful music.  An IDE is more like a fancy Casio keyboard with built-in songs and beats.  Shiny, but hollow.</p>

          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2010/05/26/is-private-a-code-smell.html">Are private methods code smells?</a></h1>
        
        <h2 class="f6 mtneg">May 26, 2010</h2>
      </header>
      
        
          <section class="section-break complete-article mb1">
            <p>Having had discussions with co-workers on the utility of private methods and <a href="http://scala-programming-language.1934581.n4.nabble.com/Just-curious-why-public-as-default-visibility-td2228941.html">recently on the scala mailing list</a>, there&#39;s been the notion that private methods (or even protected methods) are code smells -- indicators that there is something wrong with the design of your code.  I believe in many cases they can be, but that private (and protected) methods still have their uses, especially in maintaining a clean design under constraints of getting things done.  First, we need to know what we are talking about.</p>

<h2>Definitions</h2>

<p>While the technical meaning of access modifiers varies with the language, the <em>intent</em> these concepts communicate is what we&#39;re talking about here.  I assert that the <em>intent</em> of public/protected/private is (and/or should be) as follows:</p>

<ul>
<li><em>public</em> - this method is part of the published API and will not change within major versions of the class</li>
<li><em>protected</em> - this method is a hook for modifying the behavior of this class using subclasses.  It, too, will not change within major versions of the class (of course, it also might exist for code-reuse internal to the class hierarchy).</li>
<li><em>private</em> - this method was <em>refactored out of a well tested public or protected method</em> for reasons of clarity or internal re-use.  This method may absolutely change, even in patch releases, and should not be relied upon to even exist</li>
<li><em>package private</em> (bonus for Java) - this method was written by someone lazy or ignorant, <em>or</em> by someone who acknowledges that this code should be pulled out into its own class, but hasn&#39;t done so, yet still wants to test it separately, thus breaking encapsulation.</li>
</ul>

<h2>Why would private methods be code smells?</h2>

<p>The most concise argument is that private methods could indicate that the class that contains them is doing too many things.  Consider this code from shorty, my URL shortener:</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">override</span> <span class="k">def</span> <span class="n">contextInitialized</span><span class="o">(</span><span class="n">event</span><span class="k">:</span><span class="kt">ServletContextEvent</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
  <span class="n">event</span><span class="o">.</span><span class="n">getServletContext</span><span class="o">.</span><span class="n">log</span><span class="o">(</span><span class="s">&quot;Initializing our hasher/DB&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">dirName</span> <span class="k">=</span> <span class="n">event</span><span class="o">.</span><span class="n">getServletContext</span><span class="o">.</span><span class="n">getInitParameter</span><span class="o">(</span>
    <span class="nc">ShortyServlet</span><span class="o">.</span><span class="nc">DB_DIR_PARAM</span><span class="o">)</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">dirName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">dir</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">dirName</span><span class="o">)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">dir</span><span class="o">.</span><span class="n">exists</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dir</span><span class="o">.</span><span class="n">isDirectory</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">hasher</span> <span class="k">=</span> <span class="nc">URIHasher</span><span class="o">(</span><span class="nc">DB</span><span class="o">(</span><span class="n">dir</span><span class="o">))</span>
        <span class="n">hasher</span><span class="o">.</span><span class="n">start</span>
        <span class="n">uriHasher</span> <span class="k">=</span> <span class="n">hasher</span>
        <span class="n">event</span><span class="o">.</span><span class="n">getServletContext</span><span class="o">.</span><span class="n">setAttribute</span><span class="o">(</span>
          <span class="nc">ShortyServlet</span><span class="o">.</span><span class="nc">URI_HASHER_ATTRIBUTE</span><span class="o">,</span><span class="n">uriHasher</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nc">ServletException</span><span class="o">(</span><span class="n">dir</span><span class="o">.</span><span class="n">getAbsolutePath</span> 
          <span class="o">+</span> <span class="s">&quot; is not a directory&quot;</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">ServletException</span><span class="o">(</span><span class="n">dir</span><span class="o">.</span><span class="n">getAbsolutePath</span> <span class="o">+</span> <span class="s">&quot; doesn&#39;t exist&quot;</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">else</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">ServletException</span><span class="o">(</span><span class="s">&quot;You must supply a value for &quot;</span> 
      <span class="o">+</span> <span class="nc">ShortyServlet</span><span class="o">.</span><span class="nc">DB_DIR_PARAM</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Is it totally clear what this method does?  If not, it basically checks that the directory configured for our database exists and is a directory, giving us a specific error message if not.  It&#39;s a bit long and full of error checking, so the meat where it creates our URI hasher and gives it to the servlet is somewhat obscured.  Here&#39;s a cleaned up version:</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">override</span> <span class="k">def</span> <span class="n">contextInitialized</span><span class="o">(</span><span class="n">event</span><span class="k">:</span><span class="kt">ServletContextEvent</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
  <span class="n">event</span><span class="o">.</span><span class="n">getServletContext</span><span class="o">.</span><span class="n">log</span><span class="o">(</span><span class="s">&quot;Initializing our hasher/DB&quot;</span><span class="o">)</span>
  <span class="n">getDBDir</span><span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Right</span><span class="o">(</span><span class="n">dir</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">hasher</span> <span class="k">=</span> <span class="nc">URIHasher</span><span class="o">(</span><span class="nc">DB</span><span class="o">(</span><span class="n">dir</span><span class="o">))</span>
      <span class="n">hasher</span><span class="o">.</span><span class="n">start</span>
      <span class="n">uriHasher</span> <span class="k">=</span> <span class="n">hasher</span>
      <span class="n">event</span><span class="o">.</span><span class="n">getServletContext</span><span class="o">.</span><span class="n">setAttribute</span><span class="o">(</span>
        <span class="nc">ShortyServlet</span><span class="o">.</span><span class="nc">URI_HASHER_ATTRIBUTE</span><span class="o">,</span><span class="n">uriHasher</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">case</span> <span class="nc">Left</span><span class="o">(</span><span class="n">errorMessage</span><span class="o">)</span> <span class="k">=&gt;</span> 
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">ServletException</span><span class="o">(</span><span class="n">errorMessage</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">private</span> <span class="k">def</span> <span class="n">getDBDir</span><span class="o">(</span><span class="n">event</span><span class="k">:</span><span class="kt">ServletContextEvent</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">dirName</span> <span class="k">=</span> <span class="n">event</span><span class="o">.</span><span class="n">getServletContext</span><span class="o">.</span><span class="n">getInitParameter</span><span class="o">(</span>
    <span class="nc">ShortyServlet</span><span class="o">.</span><span class="nc">DB_DIR_PARAM</span><span class="o">)</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">dirName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">dir</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">dirName</span><span class="o">)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">dir</span><span class="o">.</span><span class="n">exists</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dir</span><span class="o">.</span><span class="n">isDirectory</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">Right</span><span class="o">(</span><span class="n">dir</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
        <span class="nc">Left</span><span class="o">(</span><span class="n">dir</span><span class="o">.</span><span class="n">getAbsolutePath</span> <span class="o">+</span> <span class="s">&quot; is not a directory&quot;</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
      <span class="nc">Left</span><span class="o">(</span><span class="n">dir</span><span class="o">.</span><span class="n">getAbsolutePath</span> <span class="o">+</span> <span class="s">&quot; doesn&#39;t exist&quot;</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">else</span> <span class="o">{</span>
    <span class="nc">Left</span><span class="o">(</span><span class="s">&quot;You must supply a value for &quot;</span> <span class="o">+</span> <span class="nc">ShortyServlet</span><span class="o">.</span><span class="nc">DB_DIR_PARAM</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>We&#39;ve added lines of code, but our public method is a lot clearer: we get the dir for our DB; if we get a &quot;right&quot;, we have a usable dir, and if we get a &quot;left&quot; (the Scala convention for an error), we have the error message to use for our exception.</p>

<p>So, is <code>getDBDir</code> now a code smell?  This is a private method and, this  means that <code>contextInitialized</code> was tested and we extracted the private method as step three of the TDD &quot;Test/Fix/Refactor&quot; cycle.</p>

<p>Of course, <code>getDBDir</code> has nothing to do with the <code>ServletContextListener</code> and is really all about checking for a valid path.  So, we should extract it to a new class, right?</p>

<p>Well, if we <em>did</em> do that, we&#39;ve now actually added a public API to our codebase.  Unless we make the new class completely private to the enclosing class, we&#39;ve now introduced a new public class that must be tested and managed as part of our system&#39;s public API.</p>

<p>I don&#39;t see the benefit to doing that.  I don&#39;t particularly <em>want</em> this method to be in the public API (at least not <em>now</em>).  So, what about making it a private inner class?  That doesn&#39;t seem to be much different than what we have now, though it might save a few minutes on a future extraction.</p>

<h2>When IS this a code smell?</h2>

<p>This was a simple example.  Consider a class like <a href="http://github.com/davetron5000/gliffy/blob/master/lib/gliffy/url.rb"><code>SignedUrl</code> in my Gliffy Ruby client</a>.  This class has a fair number of private methods and, overall, is pretty large.  The private methods are vague things like <code>handle<em>params</code> and <code>get</em>signing_key</code>.  The private methods aren&#39;t really the problem, however; They are a symptom of the fact that this class is just doing too many things.  A better design would be to split this class up into something like a <code>UrlParams</code>, <code>UrlSigner</code> and <code>UrlAssembler</code> (just off the top of my head).  The result would be more smaller classes, each with fewer public <em>and</em> private methods.</p>

<h2>What about protected methods?</h2>

<p>In Ruby, you don&#39;t see a lot of protected methods.  In well-designed Java frameworks (such as <a href="http://www.springframework.org">Spring</a>), you&#39;ll see them as I&#39;ve described above: hooks into a helper class that allow you to customize how that class behaves via subclassing.  In non-library code, protected methods tend to get used for code-reuse in narrowly-focused class hierarchies.  For example, the project I&#39;m working on has a <code>BaseController</code> that provides common methods to the actual web controllers.  Having used protected methods for both of these purposes, I think that, honestly, both <em>can</em> be code smells.  </p>

<h3>Protected methods as hooks</h3>

<p>In the case of providing &quot;hooks&quot;, I think it&#39;s clear that by providing them at all, you are acknowledging that your class <em>might</em> be poorly designed (or that your language lacks the expressiveness to better design it).  Consider the venerable (and now deprecated) <a href="http://static.springsource.org/spring/docs/2.5.x/api/org/springframework/web/servlet/mvc/SimpleFormController.html"><code>SimpleFormController</code></a>, a Spring MVC class that provides <em>many</em> protected-method hooks, one of which is <code>protected Map referenceData(HttpServletRequest request)</code>.  This is called during the lifecycle of the controller to get any data needed by the form that should be available to the view (for example, a list of U.S. states from the database).  Your subclass of <code>SimpleFormController</code> overrides this to provide the data as a map.</p>

<p>Why not create an interface called <code>ServletRequestToReferenceData</code> that contains this method, and inject an instance into <code>SimpleFormController</code>?  This would be very Spring-like.  My guess as to why this <em>isn&#39;t</em> the case is that there is simply too much overhead in making yet another one-method interface and the designer of <code>SimpleFormController</code> just felt this was a reasonable tradeoff.</p>

<p>In Scala, however, this could simply take a function:</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala">  <span class="k">def</span> <span class="n">referenceData</span><span class="o">[</span><span class="kt">A</span><span class="o">]((</span><span class="nc">HttpServletRequest</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Map</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">A</span><span class="o">]);</span>

  <span class="c1">// ...</span>


  <span class="n">controller</span><span class="o">.</span><span class="n">referenceData</span><span class="o">{</span> <span class="n">request</span> <span class="k">=&gt;</span> 
    <span class="c1">// create our map based on the request</span>
  <span class="o">}</span>
</code></pre></div>
<p>In Ruby, the overhead of creating a new class isn&#39;t nearly as onerous, and we could still inject a block as we do in Scala.</p>

<p>Ultimately, I would say that you have to make a tradeoff here, and it <em>has</em> to take the language and frameworks into account; a class with many, many hooks might be a code smell, but using it as a means to avoid language ceremony in the name of OO purity is probably a reasonable design tradeoff.</p>

<h3>Protected methods as code sharing</h3>

<p>This use of protected methods is harder to justify, but incredibly handy.  Still, this could be another case of Java (e.g.) not providing the necessary language features to make class extraction more straightforward.  As mentioned, in my current application, I have a <code>BaseController</code>.  It has a helper method as follows:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="n">Person</span> <span class="nf">getAndValidateLoggedInPerson</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">Person</span> <span class="n">p</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">personService</span><span class="o">.</span><span class="na">getPerson</span><span class="o">(</span>
    <span class="k">this</span><span class="o">.</span><span class="na">authenticationService</span><span class="o">.</span><span class="na">loggedInUserId</span><span class="o">());</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">NotFoundException</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>
<p>Because of Spring MVC, we have specialized exceptions for HTTP errors, such as &quot;NOT_FOUND&quot;.  Here we contain the logic to identify the id of the logged-in person as well as the check for existence.  Having this available to all controllers in the entire system is very handy.</p>

<p>But, is this a code smell?</p>

<p>We could make a class that does this, turning this code:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Person</span> <span class="n">p</span> <span class="o">=</span> <span class="n">getAndValidateLoggedInPerson</span><span class="o">();</span>
</code></pre></div>
<p>into this:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Person</span> <span class="n">p</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">personValidatorAndGetter</span><span class="o">.</span><span class="na">getPerson</span><span class="o">();</span>
</code></pre></div>
<p>creating a one method class that has many lines of injected dependencies and other boilerplate with a few actual lines of code.</p>

<p>I think this is yet another case of pragmatically dealing with language ceremony.  In Scala or Ruby, the overhead of creating re-usable bits of code like this is far lower than for Java; In Scala one could envision a simple function, possibly with some implicit parameters.   Ultimately, &quot;too much&quot; of this sort of thing <em>should</em> be a code smell, but small bits of this, in the name of simplicity, clarity, and simply keeping the codebase smaller isn&#39;t an automatic red flag.</p>

<h2>Conclusions</h2>

<p>So, are non-public methods code smells?  If we take the <a href="http://en.wikipedia.org/wiki/Code_smell">wikipedia definition</a>, which is clear that a code smell indicates merely the <em>possibility</em> of deeper problems in your code, then, yes, private and protected methods <em>are</em> code smells.</p>

<p>But, should they be avoided at all costs?  Absolutely not.  There&#39;s many valid reasons to use them, and they do not deserve the blame for an ill-conceived class.  Coding in the real world is about tradeoffs; we have to do the best thing we can with the time, resources, and tools at our disposal.  These tradeoffs may not result in an <a href="http://en.wikipedia.org/wiki/Edmond_Hoyle">According-to-Hoyle</a> OO (or functional) design, but we&#39;re not writing code to provide examples of programming paradigms or design patterns; we&#39;re writing it to accomplish something and provide value.  And, as professionals, we need to do it at a predictable rate that doesn&#39;t incur too much technical debt.</p>

          </section>
        
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2010/04/30/my-talk-at-scala-days.html">Video of My Talk at ScalaDays 2010</a></h1>
        
        <h2 class="f6 mtneg">April 30, 2010</h2>
      </header>
      
        <section class="mb1">
          <div class="excerpt"><p>
<a href="http://days2010.scala-lang.org/node/138/169">Video of my talk at ScalaDays is online</a>.  Check it out.  Feedback very much appreciated!
</p>
<p>
<a href="http://days2010.scala-lang.org/node/138/169"><img src="/images/scaladays_talk.jpg" width="400" border="0"/></a>
</p>


</div>
          <footer class="mb2 text-l">
            <a rel="full-article" class="no-ul pill" href="/blog/2010/04/30/my-talk-at-scala-days.html">Read More…</a>
          </footer>
        </section>
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2010/04/22/scala-days-recap.html">Scala Days Impressions</a></h1>
        
        <h2 class="f6 mtneg">April 22, 2010</h2>
      </header>
      
        <section class="mb1">
          <div class="excerpt"><p>
I had the good fortune to not only attend <a href="http://days2010.scala-lang.org/">ScalaDays 2010</a>, but also to speak (generously supported by <a href="http://www.opower.com">my employer</a>).  The experience overall was great.
I talked to some really enthusiastic and interesting people (including two high school kids from Austria who were using Lift because, after three years of Java, they were tired of it already!)
</p>
<h1>Overall Impressions</h1>
<ul>
    <li>Scala 2.8 has some <b>really</b> powerful new features; I'm almost <b>glad</b> I don't have a significant codebase
    using 2.7, because I would hate to <b>not</b> be able to use 2.8</li>
    <li>The conference had a wide variety of talks, at varying skill levels; this was not a "beginners-only" conference, though
    there were plenty of introductory talks (e.g. the <a href="http://akkasource.org/">Akka</a> talk).</li>
    <li>The Scala team seems very interested in moving Scala into industry and changing the perception of it as an "academic"
    language (though I'm not convinced they know what to do, nor should this be their responsibility).</li>
    <li>Most people I talked to who weren't using Scala at their jobs were looking at the strategy <a href="http://sneaking-scala.heroku.com/">I had employed</a>
    (using it for better testing), or were just frustrated with not being able to take advantage of Scala's productivity.</li>
    <li>Scala's flexible syntax and powerful constructs are being used for a very wide variety of things; there were talks
    on using it for <a href="http://processing.org/">Processing</a>, parallel collections, and cross-compilation to
    non-standard architectures (i.e. chips with no JVM available).</li>
    <li>The term "monad" was mentioned during exactly one talk and not at all for the rest of the conference.  This made
    me feel very good, because the impression I get on the Scala mailing list sometimes is that if you don't understand
    mathematical type theory, you are a moron who can never understand Scala.  This impression has been proved false.</li>
</ul>
<h2>Talks I Attended</h2>
<p>
It was very interesting to compare this conference to a <a href="http://www.nofluffjuststuff.com/home/main">No Fluff Just Stuff</a> conference.  At those, the speakers
are professional, both in that they are getting paid and that they are just, really, really good at speaking and presenting.  Their talks, however, tend to be introductory and not terribly advanced.  I think that's fine, these are the type of speakers you want to have when you need to "get the message out" on some new and interesting technologies.
</p>
<p>
The speakers at ScalaDays, however, were just regular people using Scala and wanting to talk about it.  As such, things like presentation style and slides were highly varied in terms of quality.  That being said, even the speakers who had the most trouble, still had some interesting things to talk about.  Following are my quick thoughts on each of the talks I attended:
</p>
<h3>Opening Keynote</h3>
<h4>by Martin Odersky</h4>
<p>
His talk was on the new features of Scala 2.8 which, as I said above, are quite exciting.  Package objects, new collections library, and default/named arguments are just some of the highlights.  All-in-all, some very exciting features.
</p>
<h3>Runing Scala in the Browser</h3>
<h4>by Wolfgang Kuehn</h4>
<p>
He had created a way to write Scala code and turn it into JavaScript, much like how GWT does this with Java.  His approach wasn't geared around UI widgets, however, but in creating AJAX applications using WebSockets.  I've always felt JavaScript was assembly language (which is why I think <a href="http://jashkenas.github.com/coffee-script/">coffeescript</a> is so interesting), and this was another way to leverage JavaScript without having to deal with it.
</p>
<h3>Scala Parallel Collections</h3>
<h4>by Aleksander Prokopec</h4>
<p>
This was a preview of a Scala 2.8.1 (or later) feature, where a subpackage of the new 2.8 collections library was created that could perform the collection operations in parallel.  Consider a <tt>filter</tt> on a collection; this is highly parallelizable.  This library is being created to basically implement that in a transparent fashion.  Really interesting stuff.  They had even considered load balancing, via some interesting work-stealing mechanisms.  In only 30 minutes, there wasn't a <b>huge</b> amount of detail, but this seems to be another way in which parallel computation could be done very easily.
</p>
<h3>Developing the Scala Bindings to the Fly Object Space</h3>
<h4>by Channing Walton, Nigel Warren, Simon Kent</h4>
<p>
The concept of "object spaces" never really sunk in with me, but it wasn't actually that relevant to the talk.  This was basically a comparison of a Java library and it's straight-port to Scala.  As expected, the Scala implementations were all much more succinct and (to me) clear.  The speakers hadn't used a lot of Crazy Scala Magic&#8482; to achieve the real code reduction that was shown.  This talk made it very clear that even if you write "Java in Scala", you still get a lot of productivity gains.
</p>
<h3>CCSTM: Library-based STM for Scala</h3>
<h4>by Nathan Bronson, Hassan Chafi, Kunle Olukotun</h4>
<p>
<a href="http://en.wikipedia.org/wiki/Software_transactional_memory">Software Transactional Memory</a> is one of the go-to features of Clojure.  Clojure supports it natively, while Scala does not.  This talk was on an implementation of STM as a library for Scala.  It seemed relatively simple to use and understand.  While it's not as "clean" as the Clojure way of doing things, the speaker made a solid case for a library implementation being a better tradeoff, given the difficulty in adding it to the language at this point in Scala's life (it's easy to forget how mature the Scala language and compiler are, despite how "new" it seems).
</p>
<h3>Lightweight language support for type-based, concurrent event processing</h3>
<h4>by Philipp Haller</h4>
<p>
This talk proposed a function type called "Translucent Functions" that were better-suited to concurrency than the partial functions used in the actor library.  Honestly, it was a bit over my head, and I wasn't able to catch up with the speaker.  Perhaps the paper would be more elucidating for me.
</p>
<h3>Data Parallel Programming in Scala</h3>
<h4>by Bruce Lester</h4>
<p>
This talk was very similar to the one on Scala Parallel Collections.  Here, the speaker had created a collection library separate from the Scala one, designed specifically to allow parallel processing.  He had a very different approach, using control structures to indicate areas where parallelism could occure.  It was pretty interesting, but the Scala 2.8 Collections Library implementation seemed a lot cleaner to me than this.
</p>
<h3>Type Specialization in Scala</h3>
<h4>by Iulian Drago&#x219;</h4>
<p>
One of the new features of 2.8 is the ability to "specialize" your code to work with primitive types and avoid boxing/unboxing.  This is something Java cannot really do.  This talk was an overview of how that worked and what specializations were done to the Scala library.  I guess it's nice that this kind of optimization if available, but I think it would have negligible gains for most real-world applications that weren't doing constant number crunching.  Even in that case, you don't necessarily need this.
</p>
<h3>Leaky Monads</h3>
<h4>by Josh Suereth</h4>
<p>
How could I not attend the only session (and mention!) of Monads?  The speaker gave a good overview of using Monads to
implement automatic resource management (e.g. <code>File.open { |file| file.readlines.whatever }</code>).  The idea was that since Monads are designed to hold onto the objects they manage, it's a bit inconvienient when dealing with the results of operating on managed resources.  Thus, his monads "leaked" their contents to create more concise code.
</p>
<h3>Type-safe SQL embedded in Scala</h3>
<h4>by Christoph Wulf</h4>
<p>
Akin to <a href="http://en.wikipedia.org/wiki/LINQ">LINQ</a>, this talk showed how to write SQL directly inside Scala code, but maintain type safety.  It uses
a compiler plugin to achieve this, and he talked a lot about how to tell the difference between embedded SQL and regular Scala code.  I guess the plugin introspects your database to get the types and generates a bunch of code using some Scala classes that get substituted in during compilation.  Pretty interesting.  I'm not sure I'm really <i>missing</i> SQL right in my code, but it is certainly cleaner than JDBC.
</p>
<h3>Scala at LinkedIn: Distribute Computing with Norbert</h3>
<h4>by Chris Conrad</h4>
<p>
This was a talk about how LinkedIn is using Scala to glue together some enabling technologies to create their social network graph.  It seemed really clean and simple, especially since the underlying technologies are all Java-based.  This was mostly an overview of the API and some usage examples.  It's <a href="http://sna-projects.com/norbert/">open source</a>, and looks pretty interesting.  I'm not sure it would be useful for me at my job, but definitely seems like a cool project.
</p>
<h3>Akka</h3>
<h4>by Jonas Boner</h4>
<p>
I was looking forward to this one quite a bit, as akka gets a lot of hype on Twitter.  I think 30 minutes was just too short, as it was pretty light on details.  There was a lot of assertions about Akka that the speakers just didn't have time to elucidate or substantiate.  I would love to see a comparison of Scala Actor vs. Akka Actor code and discuss why the Akka way is better.  Similarly, I'd love to see the basis for all the assertions on Akka's performance; it certainly gets a lot of hype.  Jonas is currently working on publicizing the production deployments of Akka (which would go a long way) as well as establishing commercial support for it (which <b>also</b> goes a long way :).
</p>
<h3>Scala IDE for Eclipse</h3>
<h4>by Miles Sabin</h4>
<p>
I went to this purely for my co-workers.  I hate IDEs in general, and Eclipse does some pretty evil things to my co-workers, yet many of them still swear by it.  At any rate, Miles was almost impossible for me to understand (despite being English!) and most of what I got out of the presentation was that Eclipse was very much designed to work with only Java, requiring some nasty hacks to get Scala working with it.  It seems Miles' Herculean efforts have been used to get around this and there now seems to be a nice development environment for extending and enhancing the Scala plugin.
</p>
<h3>sbt Design and Implementation</h3>
<h4>by Mark Harrah</h4>
<p>
While sbt isn't my ideal build tool, but it's a billion times better than Maven and Mark's talk actually made me appreciate it a lot more.  He is unabashedly in favor of terse symbols over long method names, and he spent some time explaining the rational behind them (thus making things make a bit more sense). His assertion is that you will eventually internalize the symbols and achieve productivity gains at a cost of a slight bump at the start.  I tend to disagree with this, because how often is one modifying their build?  This is why learning and retaining Ant and Maven is so difficult (I can't write a <tt>copy</tt> in Ant without a trip to the docs).  At any rate, this was a good talk and great overview of sbt, and, despite me not being into the crazy symbols, I will take it over Maven or Ant any day.  At least it's based in a real programming language and not some XML nonsense.
<h3>Processing with Spde</h3>
<h4>by Nathan Hamblen</h4>
<p>
This was a brief over of Processing, for those unfamiliar with this (horribly&#8208;named) visualization tool and then a review of the Scala bindingns the presenter had created.  Interestingly, he created <a href="http://technically.us/spde/About">SPDE</a> as an SBT plugin so that users could gain the benefit of SBT's automatic re-compilation and running features.  His plugin + a text editor is a makeshift IDE for Processing, which is pretty cool.  It was very high-level and didn't get into too much detail, but the Scala code was, as expected, much more concise than the Java code.
</p>
<h3>Sneaking Scala Into your Organization</h3>
<h4>by Me!</h4>
<p>
I was pretty nervous, as the many of the previous speakers' topics were all quite heady, but I had practiced my ass off, and delivered the talk as well as I could.  I think it was pretty well received and got some good questions.  I had talked with a few people previously in the conference who were using testing as a way to get Scala into their jobs and a few other people who were interested in what I had to say.  Several people were curious as to how the other developers at OPOWER liked Scala.  I felt pretty good about it.
</p>
<h3>Future of Scala</h3>
<h4>by The Scala Team</h4>
<p>
For this, we broke into small groups and basically unloaded on a poor member of the Scala team as to how anything related to Scala could be better.  Then, the Scala team assembled all of this info while Martin gave a very long term roadmap for Scala.  I do worry that the universe will never catch up to Martin and Scala team as they add more and more advanced and innovative features.
</p>
<p>
After this, a member of the Scala team did a very fast tour of the feedback.  I wish the entire list could be posted; there was a lot of very heartening complaints in there that would not be obvious from the Scala mailing list (e.g.  hate on the underscore, desire to be less academic in terminology)  This fed my (arguably self-biased) impressions that people want to get Scala into industry and that there is a large hole in this part of the Scala universe.
</p>
<p>
There were also some updates on IntelliJ's support for Scala.  They sound way ahead of the curve compared to Eclipse and NetBeans, but I was a bit frightened by IDEA's  guy saying that they way people learn languages is to ask for auto-completion and see what's available.  I see this trend all to often and I think it's harmful.  More on that later.
</p>
<h3>Overall</h3>
<p>
Despite still being stuck in Geneva, I'm glad I went.  Giving my talk was fun, but it was also great to hear about all the many ways in which people are using Scala.  I went in expecting massive academia overload, with a lot of theoretical type system and functional programming talk and got, instead, a wide variety of topics and just the right amount of academia (i.e. not that much).  Really encouraging.  Also encouraging is that ScalaDays 2011 will likely be in the Bay Area, which is a much nicer place to get stuck that stupid Geneva.
</p>


</div>
          <footer class="mb2 text-l">
            <a rel="full-article" class="no-ul pill" href="/blog/2010/04/22/scala-days-recap.html">Read More…</a>
          </footer>
        </section>
      
    </article>
  
  
    <article>
      <header>
        
        <h1 class="f4"><a class="no-ul ul-hover" href="/blog/2010/03/08/object-oriented-design.html">The only four types of classes in your OO system</a></h1>
        
        <h2 class="f6 mtneg">March 08, 2010</h2>
      </header>
      
        <section class="mb1">
          <div class="excerpt"><p>
Object-Oriented design is hard, especially in a large application.  It's not always clear where logic should go, and there's often no "right place" to  put a piece of code.  I've found that there are four distinct types of classes that, if you stick to them, can make your code a lot more understandable, and can provide clear direction as to the age-old question of "where does this code go?"
</p>
<p>
<h2>0. Background</h2>
The J2EE way is to have model objects be stupid structs, and have all business logic in a service layer (this is actually very close to a classic "functional programming" way of doing things; ironic that many Java devs eschew FP).  Spring lets you do whatever you want, but more or less follows this pattern.  
While the "Rails Way" is to put business logic on the model objects, I think the "service layer" concept <a href="http://www.engineyard.com/blog/2010/let-them-code-cake/">is eventually going to be common practice</a>.
So, I've found that I very rarely make a pure "by-the-book according-to-Hoyle" OO-compliant class; I've settled on four patterns that seem to cover pretty much everything.  I've also noticed that when these patterns get mixed together, you get trouble.
</p>
<p>
<h2>1. The Record</h2>
The <i>record</i> is a dumb struct that you usually need to appease your object-relational mapper.  You may need them elsewhere to just name and type some set of data that you either can't model as a tuple because of your language, or don't want to model as a tuple because of some complexity.  A record typically has methods that merely expose it's contents and often need to be mutable for the reasons stated.  You might have derived fields that are convieniences and not based on your core business logic.  An easy example is a person.  They have a name and a birthdate, and you might derive their age from that:
```java
public class Person {
  private String name;
  private Date birthdate;
 
  public Person(String name, Date birthdate) {
    this.name = name;
    this.birthdate = birthdate;
  }
 
  public String getName() { return this.name }
  public void setName(String name) { this.name = name; }
 
  public int getBirthdate() { return this.birthdate; }
  public void setBirthdate(Date birthdate) { 
    this.birthdate = birthdate;
  }
 
  public int getAge() {
    // I know this is slightly buggy :)
    return (
      new Date().getTime() 
      - getBirthdate().getTime()
      ) / (1000 * 60 * 60 * 24 * 365);
  }
  // Maybe some toString, equals, etc. type stuff as well
}
```
</p>
<p>
<h2>2. The Immutable Object</h2>
This is the closest to a pure "object-oriented" design.  Classes of this type are immutable and should hold data you will use a lot in your system.  They may also probably have some business-logic attached as methods; this business logic should be entirely focused on the object and its contents.  Typical methods will give you more complex information about the data the object contains, or will vend new objects of the same type, based on the method and parameters called.  
</p>
<p>
This is the most clear distinction (in my mind) between functional programming and object-oriented programming.  In an FP world, the data being operated on would be loosely defined (if at all) and you'd have functions that transform it.  In an OO world, your object's data is clearly defined (by the class fields/accessors), and the operations available are the methods of the class.  When you require that the objects of the class be immutable, you have a very nice encapsulated package of data and operations.  This, to me, seems a lot easier to deal with than a "module" of functions and some tuples (or lists of tuples) that the functions operate on.  Scala makes it very easy to create classes like this.  It's probably one of the few languages that does so (Java certainly is no help, but it <b>can</b> be done).
```java
public class Appointment {
  private final Date date;
  private final String description;
  private final Collection<Person> attendees;
 
  public Appointment(
      Date date, 
      String description, 
      Collection<Person> attendees) {
    // normally, you would validate the inputs
    // for sanity, e.g. Validate.notNull(date)
 
    // Since Date is mutable, we make a copy
    this.date = new Date(date.getTime());
    this.description = description;
    this.attendees = Collections.unmodifiableCollection(attendees);
  }
 
  public Date getDate() {
    // Since Date is mutable, we vend a copy
    return new Date(this.date.getTime());
  }
 
  public String getMessage() {
    return this.message;
  }
 
  public Collection<People> getAttendees() {
    return this.attendees;
  }
 
  public boolean isLate(Date otherDate) {
    return this.date.before(otherDate);
  }
 
  public boolean shouldRemind(Date otherDate) {
    return !isLate() && (otherDate.getTime() 
      - this.date.getTime()) >= (60 * 5 * 1000);
  }
 
  public boolean isAttending(Person p) {
    return this.attendees.contains(p);
  }
 
  public Appointment reschedule(Date newDate) {
    return new Appointment(newDate,getMessage(),getAttendees());
  }
 
  public Appointment notAttending(Person p) {
    if (isAttending(p)) {
      Collection<Person> newGroup = new HashSet<Person>(getAttendees());
      newGroup.remove(p);
      return new Appointment(getDate(),getMessage(),newGroup);
    } 
    else {
      return this;
    }
  }
 
}
```
</p>
<p>
The benefits here are huge; immutability allows your codebase to be much more comprehensible, and allows you to use these objects in concurrent situations without worry.  Since they are immutable, their methods are immediate targets for caching if you discover you need to do this to improve performance.
</p>
<p>
<h2>3. The Builder</h2>
While you can certainly use methods (or create methods) on Immutable Object classes to "build up" the object you want, this is often cumbersome, and results in a lot of object creation for no real reason.  The "builder" can be used to make this a bit simpler.  The Builder is a throwaway class whose sole purpose is to create Immutable Objects.  This obviously creates a very tight coupling between the two classes, but this can be worth it.  This is very preferable to a mutable class and, depending on your operating environment, is preferable to making many intermediate objects you will need to create the Immutable Object.
```java
public class AppointmentBuilder {
  private Date date;
  private String description;
  private List<Person> people;
 
  public AppointmentBuilder setDate(Date date) {
    this.date = date;
    return this;
  }
 
  public AppointmentBuilder setDescription(String description) {
    this.description = description;
    return this;
  }
 
  public AppointmentBuilder addPerson(Person p) {
    this.people.add(p);
    return this;
  }
 
  public Appointment build() {
    return new Appointment(date,description,people);
  }
}
```
</p>
<p>
<h2>4. The Service</h2>
The analog of The Record, the <i>service</i> has no data and all logic.  EJBs are services; they have no internal state, operating on their arguments and returning a result.  Methods of services can be very functional in nature (operating solely on structs or immutable objects), or they may provide functionality that implements complex business logic not logically part of an immutable object's class.  In a vanilla n-tier application, you use services to get data in and out of your database (you might call these DAOs and you might distinguish different types of services for partitioning, but these are all the same sort of class).
</p>
<p>
Like records, Services are not OO at all; these are the functions to your C programs structs.  But, there is a good reason for this design; you separate concerns, don't need to worry about concurrency (services have no state), and can even horizontally partition <i>where</i> serivces actually run.
```java
public class Calendaring {
  /** Schedule an appointment */
  public Appointment schedule(
      Date date, 
      String description, 
      String... names) {
    AppointmentBuilder builder = new AppointmentBuilder(date)
      .setDescription(description);
    for (String name: names) {
       Person p = findPersonByName(name);
       if (p != null) {
         builder.addPerson(p);
       }
    }
    return builder.build();
  }
}
```
</p>


</div>
          <footer class="mb2 text-l">
            <a rel="full-article" class="no-ul pill" href="/blog/2010/03/08/object-oriented-design.html">Read More…</a>
          </footer>
        </section>
      
    </article>
  
  <footer class="center border-top">
    <nav class="pt2 pb2">
      
        <a class="fw-bold prev pr2" href="page12">&larr; Older</a>
      
      <a class="" href="/blog/archives">All Posts…</a>
      
        <a class="fw-bold next pl2" href="page10">Newer &rarr;</a>
      
    </nav>
  </footer>
</div>

    </section>
  </main>
  <footer class="center">
    <p class="f6">
      Copyright &copy; 2006-2015, by David Bryant Copeland, All Rights Reserved
  </footer>
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</body></html>
