
<!DOCTYPE html>
<html language="en"><head>
  <meta charset="utf-8">
  <title>Writing even more legible SQL - naildrivin5.com - David Bryant Copeland's Website</title>
  <meta name="author" content="David Bryant Copeland">
  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/images/favicons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/images/favicons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/images/favicons/ms-icon-144x144.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  

  
  <meta name="description" content="

  
    Writing even more legible SQL
    
      November 04, 2016
    
  
  
    Craig Kerstiens wrote a great short blog post about writing more...">
  

  
  <link rel="canonical" href="http://naildrivin5.com/blog/2016/11/04/more-more-legible-sql.html">
  <link href="/favicon.png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="naildrivin5.com - David Bryant Copeland's Website" type="application/atom+xml">
  <link href="/css/styles.css" rel="stylesheet">
  <script src="https://use.typekit.net/ylm4zpa.js"></script>
  <script>try{Typekit.load({ async: true });}catch(e){}</script>
            
  <meta name="google-site-verification" content="h_yTpXa6N3ebHj8DYmgX4lIFGHBW1NtGMVHfXuu7i_4" />
</head>
<body>
  <header class="site-header pb2 mb2 center">
    <h1 class="uc ls2 f1"><a href="/">naildrivin5.com</a></h1>
    <h2 class="ls1"><small class="uc h4">Website of</small> David Bryant Copeland</h2>
    <nav>
      <ul>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/">Blog</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/bio">About</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/books">Books</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/talks">Talks</a></li>
      </ul>
      <div style="clear: both"></div>
    </nav>
  </header>
  <main>
    <section>
      <div>
<article role="article" class="blog-post">
  <header class="border-bottom border-light">
    <h1>Writing even more legible SQL</h1>
    <h2 class="f5 ls2 fw-bold mtnone uc ib">
      November 04, 2016
    </h2>
  </header>
  <section class="blog-content">
    <p><a href="http://www.craigkerstiens.com">Craig Kerstiens</a> wrote a great short blog post about <a href="http://www.craigkerstiens.com/2016/01/08/writing-better-sql/">writing more legible
SQL</a>.  It’s a great read on an important topic—SQL can be very hard to read
and modify—but I don’t think he goes far enough about “one thing per line”, so I’d like to show how <em>I</em> write SQL.</p>

<!-- more -->

<h2 id="rules-of-thumb">Rules of Thumb</h2>

<p>I’m kind of a nut for <a href="http://naildrivin5.com/blog/2013/05/17/source-code-typography.html">code typography</a>, but I think it’s important enough to get right and almost always worth going a bit farther than
you’d think so code <em>looks</em> great.</p>

<ul>
  <li>Write your SQL to be understood and read, even at the cost of modification (no leading commas FFS).</li>
  <li>Keywords in all-caps.</li>
  <li>Align, align, align, align.</li>
  <li>Don’t use table aliases unless required for disambiguation.</li>
  <li>Be consistent to a degree you never thought possible.</li>
  <li>Almost always one thing per line.  Exceptions are <code class="highlighter-rouge">AND</code> and not much else.</li>
</ul>

<p>Craig writes:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">foo</span><span class="p">,</span>
       <span class="n">bar</span>
<span class="k">FROM</span> <span class="n">baz</span>
</code></pre>
</div>

<p>This is not one thing per line.  This is (and is how I wold write that statement):</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span>
  <span class="n">foo</span><span class="p">,</span>
  <span class="n">bar</span>
<span class="k">FROM</span>
  <span class="n">baz</span>
</code></pre>
</div>

<p>I treat each part of a statement like a scoping block:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span>
  <span class="err">«</span><span class="n">fields</span><span class="err">»</span>
<span class="k">FROM</span>
  <span class="err">«</span><span class="n">tables</span><span class="err">»</span>
<span class="k">WHERE</span>
  <span class="err">«</span><span class="k">where</span> <span class="n">clauses</span><span class="err">»</span>
<span class="k">ORDER</span> <span class="k">BY</span>
  <span class="err">«</span><span class="n">ordering</span> <span class="n">fields</span><span class="err">»</span>
<span class="k">GROUP</span> <span class="k">BY</span>
  <span class="err">«</span><span class="k">grouping</span> <span class="err">»</span>
<span class="k">HAVING</span>
  <span class="err">«</span><span class="n">good</span> <span class="n">ole</span> <span class="k">HAVING</span> <span class="p">:)</span><span class="err">»</span>
<span class="p">;</span> <span class="c1">-- semi on the last line only if needed; usually I 
</span>  <span class="c1">-- omit this since it's not needed in code
</span></code></pre>
</div>

<p>Let’s take a more extreme case, because when I say “align, align, align, align”, and “be consistent to a degree you never thought possible” I’m not kidding.</p>

<p>Suppose we have a table <code class="highlighter-rouge">transactions</code> that contains credit card transactions, <code class="highlighter-rouge">users</code> containing, well, users and <code class="highlighter-rouge">addresses</code> containing
addresses (to which a user has a shipping address).  We want to get a report of transactions that includes pre-tax amount, tax amount, username, and shipping zipcode. We only want to show successful transactions and only those that used PayPal and only for users who signed up recently.</p>

<p>Here’s how I would write this query:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span>
  <span class="n">transactions</span><span class="p">.</span><span class="n">id</span>     <span class="k">AS</span> <span class="n">transaction_id</span><span class="p">,</span>
  <span class="n">transactions</span><span class="p">.</span><span class="n">amount</span> <span class="k">AS</span> <span class="n">pre_tax_amount</span><span class="p">,</span>
  <span class="n">transactions</span><span class="p">.</span><span class="n">tax</span>    <span class="k">AS</span> <span class="n">tax</span><span class="p">,</span>
  <span class="n">users</span><span class="p">.</span><span class="n">username</span>      <span class="k">AS</span> <span class="n">username</span><span class="p">,</span>
  <span class="n">addresses</span><span class="p">.</span><span class="n">zip</span>       <span class="k">AS</span> <span class="n">shipping_zip</span>
<span class="k">FROM</span>
  <span class="n">transactions</span>
<span class="k">JOIN</span>
  <span class="n">users</span>             <span class="k">ON</span> <span class="k">user</span><span class="p">.</span><span class="n">id</span>              <span class="o">=</span> <span class="n">transactions</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">JOIN</span>
  <span class="n">addresses</span>         <span class="k">ON</span> <span class="n">addresses</span><span class="p">.</span><span class="n">id</span>         <span class="o">=</span> <span class="k">user</span><span class="p">.</span><span class="n">shipping_address_id</span>
<span class="k">JOIN</span>
  <span class="n">transaction_types</span> <span class="k">ON</span> <span class="n">transaction_types</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">transactions</span><span class="p">.</span><span class="n">type_id</span>
<span class="k">WHERE</span>
  <span class="n">users</span><span class="p">.</span><span class="n">signed_up_at</span>    <span class="o">&gt;</span> <span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">interval</span> <span class="s1">'1 month'</span> <span class="k">AND</span>
  <span class="n">transactions</span><span class="p">.</span><span class="n">success</span>  <span class="o">=</span> <span class="k">true</span>                       <span class="k">AND</span>
  <span class="n">transaction_type</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'PayPal'</span>
<span class="k">ORDER</span> <span class="k">BY</span>
  <span class="n">transactions</span><span class="p">.</span><span class="n">created_at</span>
<span class="p">;</span>
</code></pre>
</div>

<p>Here’s some great things about the way this SQL is typeset:</p>

<ul>
  <li>Each line has a lot of context since we aren’t using aliases.</li>
  <li>The <code class="highlighter-rouge">FROM</code> and <code class="highlighter-rouge">WHERE</code> clauses are easy to take-in as a whole, since we’ve used aggressive typography to line things up.</li>
  <li>Similarly, the <code class="highlighter-rouge">SELECT</code>’s use of <code class="highlighter-rouge">AS</code> even for fields whose names we aren’t changing means you can easily see all the column names in one
place.</li>
  <li>The trailing <code class="highlighter-rouge">AND</code> means an errant copy/paste will cause a syntax error, not an incorrect execution.</li>
  <li>In the <code class="highlighter-rouge">JOIN</code> clauses, the table with the <code class="highlighter-rouge">.id</code> is always on the left, creating a nice rhythm when reading the statement.</li>
</ul>

<p>When you have a lot of SQL to maintain—and you will if your application does anything complex—extra care toward formatting is crucial.  SQL is
notoriously hard to test, and the general lack of abstractions available make it hard to organize in any other way.</p>

<p>Also, let’s be honest, it’s fun as hell to bikeshed other people’s coding style :)</p>

  </section>
</article>
</div>

    </section>
  </main>
  <footer class="center">
    <p class="f6">
      Copyright &copy; 2006-2016, by David Bryant Copeland, All Rights Reserved
    </p>
  </footer>
  <script type="text/javascript">
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '56a22cd9c88d90284f000861');
      t.setAttribute('data-track-path', 'https://track.gaug.es/track.gif');
      t.src = 'https://d36ee2fcip1434.cloudfront.net/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  </script>
</body></html>
