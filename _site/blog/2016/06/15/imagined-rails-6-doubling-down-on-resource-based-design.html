
<!DOCTYPE html>
<html language="en"><head>
  <meta charset="utf-8">
  <title>Imagined Rails 6: Doubling-down on Resource-based Design - naildrivin5.com - David Bryant Copeland's Website</title>
  <meta name="author" content="David Bryant Copeland">
  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/images/favicons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/images/favicons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/images/favicons/ms-icon-144x144.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  

  
  <meta name="description" content="

  
    Imagined Rails 6: Doubling-down on Resource-based Design
    
      June 15, 2016
    
  
  
    This is a series of posts about why I rec...">
  

  
  <link rel="canonical" href="http://naildrivin5.com/blog/2016/06/15/imagined-rails-6-doubling-down-on-resource-based-design.html">
  <link href="/favicon.png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="naildrivin5.com - David Bryant Copeland's Website" type="application/atom+xml">
  <link href="/css/styles.css" rel="stylesheet">
  <script src="https://use.typekit.net/ylm4zpa.js"></script>
  <script>try{Typekit.load({ async: true });}catch(e){}</script>
            
  <meta name="google-site-verification" content="h_yTpXa6N3ebHj8DYmgX4lIFGHBW1NtGMVHfXuu7i_4" />
</head>
<body>
  <header class="site-header pb2 mb2 center">
    <h1 class="uc ls2 f1"><a href="/">naildrivin5.com</a></h1>
    <h2 class="ls1"><small class="uc h4">Website of</small> David Bryant Copeland</h2>
    <nav>
      <ul>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/">Blog</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/bio">About</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/books">Books</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/talks">Talks</a></li>
      </ul>
      <div style="clear: both"></div>
    </nav>
  </header>
  <main>
    <section>
      <div>
<article role="article" class="blog-post">
  <header class="border-bottom border-light">
    <h1>Imagined Rails 6: Doubling-down on Resource-based Design</h1>
    <h2 class="f5 ls2 fw-bold mtnone uc ib">
      June 15, 2016
    </h2>
  </header>
  <section class="blog-content">
    <p>This is a series of posts about <a href="http://naildrivin5.com/blog/2016/06/12/why-did-i-recommend-XX-for-rails-6.html">why I recommended the changes I did for Rails 6</a>, in my <a href="http://naildrivin5.com/blog/2016/05/17/announcing-rails-6-an-imagined-roadmap.html">imagined keynote
for Rails 6</a>.</p>

<p>In this one, we’ll explore why I recommended changes that encourage a more resource-based design.</p>

<!-- more -->

<h2 id="resourceful-design-is-cleaner">Resourceful Design is Cleaner</h2>

<p>I agree with DHH that <a href="http://jeromedalbert.com/how-dhh-organizes-his-rails-controllers/">if you firmly stick to a resource-based design, and avoid RPC-style routes, you will have cleaner code and cleaner controllers</a>.  Because of this, It’s surprising to me that Rails requires you to use <code class="highlighter-rouge">config/routes.rb</code> for basic, resourceful routing.</p>

<p>To my mind, creating a class named <code class="highlighter-rouge">WidgetsController</code> in <code class="highlighter-rouge">app/controllers</code> that inherits from <code class="highlighter-rouge">ApplicationController</code> and contains a method <code class="highlighter-rouge">index</code> is a pretty strong and unambiguous message from a developer that they want the route <code class="highlighter-rouge">/widgets</code> to respond to an HTTP <code class="highlighter-rouge">GET</code>.</p>

<p>The way I see a lot of developers deal with this (admittedly tiny) boilerplate is to declare that a resource responds to all verbs, like so:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1"># config/routes.rb</span>

<span class="n">resources</span> <span class="ss">:widgets</span>

<span class="c1"># app/controllers/widgets_controller.rb</span>
<span class="k">class</span> <span class="nc">WidgetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@widget</span> <span class="o">=</span> <span class="no">Widgets</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="c1"># that's it</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This tells Rails that your application responds to all the magic seven routes for a widget, yet implements only one of them.  It makes <code class="highlighter-rouge">rake routes</code> confusing.  Developers do it because doing <code class="highlighter-rouge">resources :widgets, only: [ :show ]</code> is a pain in the ass.</p>

<p>I also see developers rush through their controller design and add RPC-style endpoints.  For example, if we wanted to
distinguish archiving a widget from deleting it, most developers would make an <code class="highlighter-rouge">archive</code> method.  If, instead, you created a
resource called <code class="highlighter-rouge">ArchivedWidgets</code> and accepted a POST, that would be more resourceful and likely much cleaner design.</p>

<p>If resourceful routes were derived from controllers, it would also make it very easy to spot deviations and have conversations around them.  In an ideal Rails application, <code class="highlighter-rouge">config/routes.rb</code> wouldn’t change that often, so if it did, it’s a big red flag to talk about the design of the feature that changed it.</p>

<p>One hard part about doing this is if your resource isn’t an ActiveRecord, there is a bit of friction you have to fight through.</p>

<h2 id="encouraging-non-activerecord-resources">Encouraging Non-ActiveRecord Resources</h2>

<p>If it were just as easy to create non-ActiveRecord resources as it were ActiveRecord-based ones, this would further encourage resource-based design.  There are two problems to solve here.</p>

<p>The first is how to provide a non-ActiveRecord object all the needed functionality that Rails’ form and URL helpers expect.  This can be achieved with Active Model, though Active Model is a pretty large interface.</p>

<p>The second problem is how to properly assemble such a resource using possibly disparate bits of Active Records.  In my post, I listed an “Account” resource as an example.  In our hypothetical application, the account view shows some user information, such as their name and email, but also information about their most recent order.</p>

<p>This is typically solved via some sort of presenter framework, and there are a <strong>lot</strong> of them.  Their existence says to me that Rails developers want such a framework, and Rails could greatly help us by providing one that was easy to use and full-featured.</p>

<p>The “presenter” situation in real Rails apps isn’t good.  Where I work, across our Rails apps, we have:</p>

<ul>
  <li>Hand-created presenters just using <code class="highlighter-rouge">class</code></li>
  <li>Presenters using our <a href="http://github.com/stitchfix/immutable-struct">immutable-struct</a> library</li>
  <li>View Models created by hand</li>
  <li>Mixins that add view-specific methods to ActiveRecords</li>
  <li>Methods in ActiveRecords only for displaying derived or formatted data in a view</li>
  <li>Classes that mix in some of Active Model’s modules (these were created before Rails 4 added a single ActiveModel mixin)</li>
  <li>A base presenter that delegates to a wrapped ActiveRecord using <code class="highlighter-rouge">method_missing</code>.</li>
</ul>

<p>My team has done a good job of keeping things consistent in many other areas, but none of these solutions are great, which is probably why we have used so many.</p>

<p>My post postulated a DSL to create these resources.  I’m not hooked on that, but I think the general needs developers have are:</p>

<ul>
  <li>works with form and URL helpers</li>
  <li>allows delegation of methods directly to other objects</li>
  <li>easily use Rails helpers to implement methods for derived or formatted values</li>
</ul>

<p>I don’t think ActiveModel is this.  ActiveModel is both too much and not enough, and I think it fails at encouraging both
resource-based design as well as another Rails-ism that most people ignore: model-driven design.</p>

<p>Up until Rails 4.2, a model was a database table was a model.  With ActiveModel this isn’t the case, however Rails has totally
failed at helping developers adopt model-driven design.</p>

<p>But, encouraging resource-oriented design for controllers, and providing a simple framework for creating non-ActiveRecord
models, I think this could be saved.</p>

<p>Taking our account example, suppose that the account screen wants to allow users to modify some of those details.  Suppose further that we show a user’s subscription frequency on this page, too, and that it is modifiable.</p>

<p>Most Rails developers would solve this in one of these ways:</p>

<ul>
  <li>Put the update logic in the controller - call into the <code class="highlighter-rouge">User</code> and then the <code class="highlighter-rouge">Subscription</code>.</li>
  <li>Create a service object or command object that does the work</li>
  <li>Put it all into either <code class="highlighter-rouge">User</code> or <code class="highlighter-rouge">Subscription</code></li>
</ul>

<p>The Rails way is to put the logic on a model, and if we could create an <code class="highlighter-rouge">Account</code> model just as easily as we created our <code class="highlighter-rouge">User</code>
and <code class="highlighter-rouge">Subscription</code> models, we could do this the Rails way, but without bloating our ActiveRecords:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ActionResource</span>
  <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
      <span class="n">user</span><span class="p">.</span><span class="nf">email</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:email</span><span class="p">]</span>
      <span class="n">subscription</span><span class="p">.</span><span class="nf">cadence</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:subscription_cadence</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">valid?</span> <span class="c1"># provided by ActionResource</span>
        <span class="n">user</span><span class="p">.</span><span class="nf">save</span>
        <span class="n">subscription</span><span class="p">.</span><span class="nf">save</span>
      <span class="k">end</span>
    <span class="k">end</span>    
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This very much follows the Rails Way of “model-driven design” and/or Rails’ interpretation of what OO is.</p>

<p>To be clear, I don’t think this is necessarily the best way to write code in a Rails app, but this is <em>much</em> better than just throwing everything into your User model.  In fact, if a complex Rails app aggressively pursued this sort of design, it might result in fairly clean code, comprised of objects that don’t do all that much (which is what we’re all after by making services).</p>

<p>I can only assume this is the sort of thing DHH has in mind and why he tends to eschew any “blessing” of objects that aren’t models.  It’s too bad that there hasn’t been clearer instruction and explanation as to how it would work for non-trivial cases.  But, by encouraging a resource-based view of controllers and making it dead-simple to create non-ActiveRecord models, Rails might more naturally encourage the type of design it seems to favor.</p>


  </section>
</article>
</div>

    </section>
  </main>
  <footer class="center">
    <p class="f6">
      Copyright &copy; 2006-2017, by David Bryant Copeland, All Rights Reserved
    </p>
  </footer>
  <script type="text/javascript">
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '56a22cd9c88d90284f000861');
      t.setAttribute('data-track-path', 'https://track.gaug.es/track.gif');
      t.src = 'https://d36ee2fcip1434.cloudfront.net/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  </script>
</body></html>
