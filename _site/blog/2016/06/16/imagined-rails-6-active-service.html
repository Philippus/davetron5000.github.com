
<!DOCTYPE html>
<html language="en"><head>
  <meta charset="utf-8">
  <title>Imagined Rails 6: Why A Service Layer? - naildrivin5.com - David Bryant Copeland's Website</title>
  <meta name="author" content="David Bryant Copeland">
  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/images/favicons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/images/favicons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/images/favicons/ms-icon-144x144.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  

  
  <meta name="description" content="

  
    Imagined Rails 6: Why A Service Layer?
    
      June 16, 2016
    
  
  
    This is a series of posts about why I recommended the chang...">
  

  
  <link rel="canonical" href="http://naildrivin5.com/blog/2016/06/16/imagined-rails-6-active-service.html">
  <link href="/favicon.png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="naildrivin5.com - David Bryant Copeland's Website" type="application/atom+xml">
  <link href="/css/styles.css" rel="stylesheet">
  <script src="https://use.typekit.net/ylm4zpa.js"></script>
  <script>try{Typekit.load({ async: true });}catch(e){}</script>
            
  <meta name="google-site-verification" content="h_yTpXa6N3ebHj8DYmgX4lIFGHBW1NtGMVHfXuu7i_4" />
</head>
<body>
  <header class="site-header pb2 mb2 center">
    <h1 class="uc ls2 f1"><a href="/">naildrivin5.com</a></h1>
    <h2 class="ls1"><small class="uc h4">Website of</small> David Bryant Copeland</h2>
    <nav>
      <ul>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/">Blog</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/bio">About</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/books">Books</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/talks">Talks</a></li>
      </ul>
      <div style="clear: both"></div>
    </nav>
  </header>
  <main>
    <section>
      <div>
<article role="article" class="blog-post">
  <header class="border-bottom border-light">
    <h1>Imagined Rails 6: Why A Service Layer?</h1>
    <h2 class="f5 ls2 fw-bold mtnone uc ib">
      June 16, 2016
    </h2>
  </header>
  <section class="blog-content">
    <p>This is a series of posts about <a href="http://naildrivin5.com/blog/2016/06/12/why-did-i-recommend-XX-for-rails-6.html">why I recommended the changes I did for Rails 6</a>, in my <a href="http://naildrivin5.com/blog/2016/05/17/announcing-rails-6-an-imagined-roadmap.html">imagined keynote
for Rails 6</a>.</p>

<p>In this one, we’ll explore why I think having explicit support for creating non-model service objects would be a good thing.</p>

<!-- more -->

<p>I hypothesized ActiveService, which is a lightweight library that basically allows you to specify the dependencies of an object to other objects.</p>

<p>For example, if you have code to charge a customer some money, that code depends on your payment processor’s Ruby library and also on your Rails mailer (to email a receipt).  Rather than simply use those two classes directly, you’d use Active Service’s imagined DSL:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Purchaser</span> <span class="o">&lt;</span> <span class="no">ActiveService</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">needs</span> <span class="ss">:braintree</span>
  <span class="n">needs</span> <span class="ss">:receipt_mailer</span>

  <span class="k">def</span> <span class="nf">purchase!</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">braintree</span><span class="p">.</span><span class="nf">charge_card</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="nf">customer</span><span class="p">,</span><span class="n">order</span><span class="p">.</span><span class="nf">amount</span><span class="p">)</span>
      <span class="n">receipt_mailer</span><span class="p">.</span><span class="nf">receipt</span><span class="p">(</span><span class="n">order</span><span class="p">).</span><span class="nf">deliver!</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This is admittedly not very Ruby and <em>definitely</em> not very Rails.  I also think this part of my imagined keynote has the weakest evidence to justify it.  But, I did want to talk about why I think this is useful, despite this not being very idiomatic Ruby.</p>

<p>Rails (and Ruby) code tends to involved hard-coding inter-object dependencies, usually by directly referencing global symbols.  In theory, this is bad because if you need to modify those dependencies it’s difficult to do.  It’s also bad, in theory, because it makes testing more difficult.</p>

<p>In practice, neither of these are real problems.  Ruby allows you to easily mock/stub/replace hard-coded dependencies in tests, and I’ve rarely encountered a case where the primary problem in making a change was in modifying a dependency on another class.</p>

<p>As a way to author classes, I don’t think Active Service is super-compelling.  I think it has some small benefits, and I would use it if it existed, but generally for the production code, it’s not a big win.</p>

<p>Where I think it <em>could</em> be a big win is for testing.</p>

<p>Because our class’ dependencies are made explicit, the testing framework can examine them and set up mocks/stubs/doubles/whatevers.</p>

<p>In theory, the test support included with ActiveService would be able to example a class’ dependent objects, look at their type, and stub out all their methods.  It could then allow the test author to make assertions about how those methods were called (and, of course, control what they do to orchestrate a test).</p>

<p>This should be a superior experience to using a mocking framework, since it would be baked into Rails and would be default behavior.  It would also encourage test isolation, basically by making it really hard to write an integration test-masquerading-as-a-unit test.</p>

<p>This somewhat flies in the face of what I had discussed about resource-orientation.  The existence of Active Serivce sends the message “code doesn’t go in model objects”.  I believe this very strongly, but it’s not The Rails Way.</p>


  </section>
</article>
</div>

    </section>
  </main>
  <footer class="center">
    <p class="f6">
      Copyright &copy; 2006-2017, by David Bryant Copeland, All Rights Reserved
    </p>
  </footer>
  <script type="text/javascript">
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '56a22cd9c88d90284f000861');
      t.setAttribute('data-track-path', 'https://track.gaug.es/track.gif');
      t.src = 'https://d36ee2fcip1434.cloudfront.net/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  </script>
</body></html>
