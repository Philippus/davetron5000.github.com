
<!DOCTYPE html>
<html language="en"><head>
  <meta charset="utf-8">
  <title>Adventures in functional programming with Ruby - naildrivin5.com - David Bryant Copeland's Website</title>
  <meta name="author" content="David Bryant Copeland">
  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/images/favicons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/images/favicons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/images/favicons/ms-icon-144x144.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  

  
  <meta name="description" content="

  
    Adventures in functional programming with Ruby
    
      July 17, 2012
    
  
  
    The following is an aimless journey through a degen...">
  

  
  <link rel="canonical" href="http://naildrivin5.com/blog/2012/07/17/adventures-in-functional-programming-with-ruby.html">
  <link href="/favicon.png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="naildrivin5.com - David Bryant Copeland's Website" type="application/atom+xml">
  <link href="/css/styles.css" rel="stylesheet">
  <script src="https://use.typekit.net/ylm4zpa.js"></script>
  <script>try{Typekit.load({ async: true });}catch(e){}</script>
            
  <meta name="google-site-verification" content="h_yTpXa6N3ebHj8DYmgX4lIFGHBW1NtGMVHfXuu7i_4" />
</head>
<body>
  <header class="site-header pb2 mb2 center">
    <h1 class="uc ls2 f1"><a href="/">naildrivin5.com</a></h1>
    <h2 class="ls1"><small class="uc h4">Website of</small> David Bryant Copeland</h2>
    <nav>
      <ul>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/">Blog</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/bio">About</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/books">Books</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/talks">Talks</a></li>
      </ul>
      <div style="clear: both"></div>
    </nav>
  </header>
  <main>
    <section>
      <div>
<article role="article" class="blog-post">
  <header class="border-bottom border-light">
    <h1>Adventures in functional programming with Ruby</h1>
    <h2 class="f5 ls2 fw-bold mtnone uc ib">
      July 17, 2012
    </h2>
  </header>
  <section class="blog-content">
    <p>The following is an aimless journey through a degenerate form of Ruby, in an effort to learn a bit more about functional programming, simplicity, and API design.</p>

<p>Suppose that the only way we have to organize code in Ruby is to make lambdas, and the only way we have to structure data are arrays:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">square</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="p">}</span>
<span class="n">square</span><span class="o">.</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># =&gt; 16</span>

<span class="n">person</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Dave"</span><span class="p">,</span><span class="ss">:male</span><span class="p">]</span>
<span class="n">print_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">((</span><span class="nb">name</span><span class="p">,</span><span class="n">gender</span><span class="p">))</span> <span class="p">{</span> 
  <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> is a </span><span class="si">#{</span><span class="n">gender</span><span class="si">}</span><span class="s2">"</span>
<span class="p">}</span>
<span class="n">print_person</span><span class="o">.</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</code></pre>
</div>

<p>This is the most bare-bones essence of functional programming: all we have is functions.   Let’s write some real-ish code this way and see how far we get before it starts
becoming painful.</p>

<!-- more -->

<p>Suppose we want to manipulate a database of people, and someone has provided us a few functions to interact with a data store.   We want to use these to add a UI and some validations.</p>

<p>Here’s how we interact with our data store:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">insert_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">)</span> <span class="c1"># =&gt; returns an id</span>
<span class="n">update_person</span><span class="o">.</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span><span class="n">new_birthdate</span><span class="p">,</span><span class="n">new_gender</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
<span class="n">delete_person</span><span class="o">.</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="n">fetch_person</span><span class="o">.</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="c1"># =&gt; returns the name, birthdate, and gender as an array</span>
</code></pre>
</div>

<p>First, we need to be able to add a person to our database, along with some validations.  We’ll get this data from user input (we can assume that <code class="highlighter-rouge">puts</code> and <code class="highlighter-rouge">gets</code> are built-ins that work as expected):</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">puts</span> <span class="s2">"Name?"</span>
<span class="nb">name</span> <span class="o">=</span> <span class="nb">gets</span>

<span class="nb">puts</span> <span class="s2">"Birthdate?"</span>
<span class="n">birthdate</span> <span class="o">=</span> <span class="nb">gets</span>

<span class="nb">puts</span> <span class="s2">"Gender?"</span>
<span class="n">gender</span> <span class="o">=</span> <span class="nb">gets</span>
</code></pre>
</div>

<p>We need a function to do our validations and add a person to the database.  What might it look like?  It should accept the attributes of a person and return
either an id (on successfully validation and insertion), or an error message, representing what went wrong.   Since we don’t have exceptions or hashes - just arrays -
we’re going to have to get creative.</p>

<p>Let’s create a convention in our system that every business logic methods returns an array of size 2.  The first element is the return value on success, and
the second element is an error message on failure.  The presence or absence of data in one of these slots indicates the result.</p>

<p>Now that we’ve sorted out what we accept as arguments and what we’re going to return, let’s write our function:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">add_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Name is required"</span><span class="p">]</span>                  <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Birthdate is required"</span><span class="p">]</span>             <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">birthdate</span><span class="p">)</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Gender is required"</span><span class="p">]</span>                <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">gender</span><span class="p">)</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Gender must be 'male' or 'female'"</span><span class="p">]</span> <span class="k">if</span> <span class="n">gender</span> <span class="o">!=</span> <span class="s1">'male'</span> <span class="o">&amp;&amp;</span> <span class="n">gender</span> <span class="o">!=</span> <span class="s1">'female'</span>

  <span class="nb">id</span> <span class="o">=</span> <span class="n">insert_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">)</span>
  <span class="p">[[</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="nb">id</span><span class="p">],</span><span class="kp">nil</span><span class="p">]</span>
<span class="p">}</span>
</code></pre>
</div>

<p>If you aren’t familiar with <code class="highlighter-rouge">String()</code>, it is a function that coalesces nil to the empty string, so we don’t have to check for both.</p>

<p>With this function, what we’d like to do is call it in a loop until the user has provided correct input, like so:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">invalid</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">while</span> <span class="n">invalid</span>
  <span class="nb">puts</span> <span class="s2">"Name?"</span>
  <span class="nb">name</span> <span class="o">=</span> <span class="nb">gets</span>
  <span class="nb">puts</span> <span class="s2">"Birthdate?"</span>
  <span class="n">birthdate</span> <span class="o">=</span> <span class="nb">gets</span>
  <span class="nb">puts</span> <span class="s2">"Gender?"</span>
  <span class="n">gender</span> <span class="o">=</span> <span class="nb">gets</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">add_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="kp">nil</span>
    <span class="nb">puts</span> <span class="s2">"Successfully added person </span><span class="si">#{</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">invalid</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="k">else</span>
    <span class="nb">puts</span> <span class="s2">"Problem: </span><span class="si">#{</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Of course, we never said anything about <code class="highlighter-rouge">while</code> loops :)  Suppose we don’t have them.</p>

<h2 id="loops-are-just-functions-called-recursively">Loops are just functions (called recursively)</h2>

<p>To loop, we simply wrap our code in a function and call it recursively until we achieve the desired result.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">get_new_person</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span>
  <span class="nb">puts</span> <span class="s2">"Name?"</span>
  <span class="nb">name</span> <span class="o">=</span> <span class="nb">gets</span>
  <span class="nb">puts</span> <span class="s2">"Birthdate?"</span>
  <span class="n">birthdate</span> <span class="o">=</span> <span class="nb">gets</span>
  <span class="nb">puts</span> <span class="s2">"Gender?"</span>
  <span class="n">gender</span> <span class="o">=</span> <span class="nb">gets</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">add_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="kp">nil</span>
    <span class="nb">puts</span> <span class="s2">"Successfully added person </span><span class="si">#{</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">else</span>
    <span class="nb">puts</span> <span class="s2">"Problem: </span><span class="si">#{</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">get_new_person</span><span class="o">.</span><span class="p">()</span>
  <span class="k">end</span>
<span class="p">}</span>

<span class="n">person</span> <span class="o">=</span> <span class="n">get_new_person</span><span class="o">.</span><span class="p">()</span>
</code></pre>
</div>

<p>We can envision that our code is going to have a lot of <code class="highlighter-rouge">if result[1] == nil</code> in it, so let’s wrap it in a function.
The great thing about functions is that they allow us to re-use structure, as opposed to logic.  The structure here is 
checking for an error and doing one thing on success and another on error.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">handle_result</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">on_success</span><span class="p">,</span><span class="n">on_error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="kp">nil</span>
    <span class="n">on_success</span><span class="o">.</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">else</span>
    <span class="n">on_error</span><span class="o">.</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="k">end</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now, our <code class="highlighter-rouge">get_new_person</code> function abstracts away the error handling:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">get_new_person</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span>
  <span class="nb">puts</span> <span class="s2">"Name?"</span>
  <span class="nb">name</span> <span class="o">=</span> <span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="nb">puts</span> <span class="s2">"Birthdate?"</span>
  <span class="n">birthdate</span> <span class="o">=</span> <span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="nb">puts</span> <span class="s2">"Gender?"</span>
  <span class="n">gender</span> <span class="o">=</span> <span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span>

  <span class="n">result</span> <span class="o">=</span> <span class="n">add_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">)</span>

  <span class="n">handle_result</span><span class="o">.</span><span class="p">(</span><span class="n">result</span><span class="p">,</span>
    <span class="o">-&gt;</span><span class="p">((</span><span class="nb">id</span><span class="p">,</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">))</span> <span class="p">{</span>
      <span class="nb">puts</span> <span class="s2">"Successfully added person </span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span>
      <span class="p">[</span><span class="nb">id</span><span class="p">,</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="nb">id</span><span class="p">]</span>
    <span class="p">},</span> 
    <span class="o">-&gt;</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">puts</span> <span class="s2">"Problem: </span><span class="si">#{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">get_new_person</span><span class="o">.</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="n">person</span> <span class="o">=</span> <span class="n">get_new_person</span><span class="o">.</span><span class="p">()</span>
</code></pre>
</div>

<p>Notice what the use of <code class="highlighter-rouge">handle_result</code> allows us to explicitly name variables, instead of using Array de-referencing.  Not only can we name <code class="highlighter-rouge">error_message</code>, but, using Ruby’s
array-extraction syntax, we can “explode” our person array into its attributes via the <code class="highlighter-rouge">((id,name,birthdate,gender))</code> syntax.</p>

<p>So far, so good.  This code is probably a bit weird looking, but it’s not terribly verbose, or complex.</p>

<h2 id="clean-code-uses-more-functions">Clean code uses more functions.</h2>

<p>One thing that might seem odd is that our person has no real structure or formal definition.  We simply have an array, and a
convention that the first element is the name, second element is birthdate, etc.  Our domain is pretty simple as-is, but let’s
suppose we want to add a new field: title.  What happens to our code when we do this?</p>

<p>Our database team delivers new versions of <code class="highlighter-rouge">insert_person</code> and <code class="highlighter-rouge">update_person</code> to us:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">insert_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>
<span class="n">update_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
</code></pre>
</div>

<p>We then have to update our <code class="highlighter-rouge">add_person</code> method:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">add_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Name is required"</span><span class="p">]</span>                  <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Birthdate is required"</span><span class="p">]</span>             <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">birthdate</span><span class="p">)</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Gender is required"</span><span class="p">]</span>                <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">gender</span><span class="p">)</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Gender must be 'male' or 'female'"</span><span class="p">]</span> <span class="k">if</span> <span class="n">gender</span> <span class="o">!=</span> <span class="s1">'male'</span> <span class="o">&amp;&amp;</span> <span class="n">gender</span> <span class="o">!=</span> <span class="s1">'female'</span>

  <span class="nb">id</span> <span class="o">=</span> <span class="n">insert_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>

  <span class="p">[[</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="p">],</span><span class="kp">nil</span><span class="p">]</span>
<span class="p">}</span>
</code></pre>
</div>

<p>And, since we use these extractions in <code class="highlighter-rouge">get_new_person</code>, <strong>that</strong> has to change, too.  Ugh:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">get_new_person</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span>
  <span class="nb">puts</span> <span class="s2">"Name?"</span>
  <span class="nb">name</span> <span class="o">=</span> <span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="nb">puts</span> <span class="s2">"Birthdate?"</span>
  <span class="n">birthdate</span> <span class="o">=</span> <span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="nb">puts</span> <span class="s2">"Gender?"</span>
  <span class="n">gender</span> <span class="o">=</span> <span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="nb">puts</span> <span class="s2">"Title?"</span>
  <span class="n">title</span> <span class="o">=</span> <span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span>

  <span class="n">result</span> <span class="o">=</span> <span class="n">add_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>

  <span class="n">handle_result</span><span class="o">.</span><span class="p">(</span><span class="n">result</span><span class="p">,</span>
    <span class="o">-&gt;</span><span class="p">((</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="p">))</span> <span class="p">{</span>
      <span class="nb">puts</span> <span class="s2">"Successfully added person </span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span>
      <span class="p">[</span><span class="nb">id</span><span class="p">,</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="p">]</span>
    <span class="p">},</span> 
    <span class="o">-&gt;</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">puts</span> <span class="s2">"Problem: </span><span class="si">#{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">get_new_person</span><span class="o">.</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p>This is the very definition of high-coupling.  <code class="highlighter-rouge">get_new_person</code> really shouldn’t care about the particular fields of a person; it
should simply read them in, and then pass them to <code class="highlighter-rouge">add_person</code>.  Let’s see if we can make that happen by extracting some of this code into new functions.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">read_person_from_user</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span>
  <span class="nb">puts</span> <span class="s2">"Name?"</span>
  <span class="nb">name</span> <span class="o">=</span> <span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="nb">puts</span> <span class="s2">"Birthdate?"</span>
  <span class="n">birthdate</span> <span class="o">=</span> <span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="nb">puts</span> <span class="s2">"Gender?"</span>
  <span class="n">gender</span> <span class="o">=</span> <span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="nb">puts</span> <span class="s2">"Title?"</span>
  <span class="n">title</span> <span class="o">=</span> <span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="p">[</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">person_id</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">_</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span> <span class="p">{</span> <span class="nb">id</span> <span class="p">}</span>

<span class="n">get_new_person</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span>
  <span class="n">handle_result</span><span class="o">.</span><span class="p">(</span><span class="n">add_person</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">read_person_from_user</span><span class="o">.</span><span class="p">())</span>
    <span class="o">-&gt;</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">puts</span> <span class="s2">"Successfully added person </span><span class="si">#{</span><span class="n">person_id</span><span class="o">.</span><span class="p">(</span><span class="n">person</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">person</span>
    <span class="p">},</span> 
    <span class="o">-&gt;</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">puts</span> <span class="s2">"Problem: </span><span class="si">#{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">get_new_person</span><span class="o">.</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p>We’ve now abstracted the way in which we store a person into two functions: <code class="highlighter-rouge">read_person_from_user</code> and <code class="highlighter-rouge">person_id</code>.  At this
point, <code class="highlighter-rouge">get_new_person</code> will not need to change if we add more fields to a person.</p>

<p>If you’re confused about the use of <code class="highlighter-rouge">*</code> in this code, here’s a brief explanation:  <code class="highlighter-rouge">*</code> allows us to treat an array as a list of arguments and vice versa.  In <code class="highlighter-rouge">person_id</code>, we
use the parameter list <code class="highlighter-rouge">*_,id</code>, which tells Ruby to place all arguments to the function, save the last, into the variable <code class="highlighter-rouge">_</code> (so-named because we don’t care about its value),
and place the last argument in the variable <code class="highlighter-rouge">id</code>.  This only works in Ruby 1.9; in 1.8 only the last argument of a function may use the <code class="highlighter-rouge">*</code> syntax.  Further, when we call
<code class="highlighter-rouge">add_person</code>, we use the <code class="highlighter-rouge">*</code> on the results of <code class="highlighter-rouge">read_person_from_user</code>.  Since <code class="highlighter-rouge">read_person_from_user</code> returns an array, we want to treat that array as if it were an argument
list, since <code class="highlighter-rouge">add_person</code> accepts explicit arguments.  The <code class="highlighter-rouge">*</code> does that for us.  Nice!</p>

<p>Back to our code, you’ll note that we still have coupling between <code class="highlighter-rouge">read_person_from_user</code> and <code class="highlighter-rouge">person_id</code>.  They both are intimate with how we store a person in an array.
Further, if we added new features to actually <em>do</em> something with our people database, we can envision more methods coupled to this array-based format.</p>

<p>We need some sort of data structure.</p>

<h1 id="data-structures-are-just-functions">Data structures are just functions</h1>

<p>In non-degenerate Ruby, we’d probably make a class at this point, or at least us a <code class="highlighter-rouge">Hash</code>, but we don’t have access to those
here.  Can we make a real data structure just using functions?  It turns out we can, if we create a function that treats its first argument as an attribute of our data
structure:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">new_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">id</span>        <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:id</span>
    <span class="k">return</span> <span class="nb">name</span>      <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:name</span>
    <span class="k">return</span> <span class="n">birthdate</span> <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:birthdate</span>
    <span class="k">return</span> <span class="n">gender</span>    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:gender</span>
    <span class="k">return</span> <span class="n">title</span>     <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:title</span>
    <span class="kp">nil</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">dave</span> <span class="o">=</span> <span class="n">new_person</span><span class="o">.</span><span class="p">(</span><span class="s2">"Dave"</span><span class="p">,</span><span class="s2">"06-01-1974"</span><span class="p">,</span><span class="s2">"male"</span><span class="p">,</span><span class="s2">"Baron"</span><span class="p">)</span>
<span class="nb">puts</span> <span class="n">dave</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>   <span class="c1"># =&gt; "Dave"</span>
<span class="nb">puts</span> <span class="n">dave</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="c1"># =&gt; "male"</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">new_person</code> acts like a constructor, but instead of returning an object (which don’t exist for us), we return a function that, when called, can tell us the values of the
various attributes of our person.  We explicitly itemize the possible attributes, so we have a fairly firm definition of what the type of a person is.</p>

<p>Compare this to a class that does the same thing:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">attr_reader</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:birthdate</span><span class="p">,</span> <span class="ss">:gender</span><span class="p">,</span> <span class="ss">:title</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
    <span class="vi">@id</span> <span class="o">=</span> <span class="nb">id</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
    <span class="vi">@birthdate</span> <span class="o">=</span> <span class="n">birthdate</span>
    <span class="vi">@gender</span> <span class="o">=</span> <span class="n">gender</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="n">title</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">dave</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Dave"</span><span class="p">,</span><span class="s2">"06-01-1974"</span><span class="p">,</span><span class="s2">"male"</span><span class="p">,</span><span class="s2">"Baron"</span><span class="p">)</span>
<span class="nb">puts</span> <span class="n">dave</span><span class="p">.</span><span class="nf">name</span> 
<span class="nb">puts</span> <span class="n">dave</span><span class="p">.</span><span class="nf">gender</span>
</code></pre>
</div>

<p>Interesting.  The size of these two bits of code is more or less the same, but the class-based version is full of <em>special forms</em>.  Special Forms are essentially magic provided by the language or runtime.  To understand this code, you need to know:</p>

<ul>
  <li>what <code class="highlighter-rouge">class</code> means</li>
  <li>that calling <code class="highlighter-rouge">new</code> on the class’s name calls the <code class="highlighter-rouge">initialize</code> methods</li>
  <li>what methods are</li>
  <li>that prepending <code class="highlighter-rouge">@</code> to a variable makes it private to the class’ instance</li>
  <li>the difference between a class and an instance</li>
  <li>what <code class="highlighter-rouge">attr_reader</code> does</li>
</ul>

<p>Compared to our functional version, all you need to know is:</p>

<ul>
  <li>how to define a function</li>
  <li>how to invoke a function</li>
</ul>

<p>Like I said, I find this interesting.  We have two ways of writing essentially the same code, and one way requires you to have a lot more special knowledge than the other.</p>

<p>OK, now that we have a real data structure, let’s rework our code to use it, instead of arrays:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">read_person_from_user</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span>
  <span class="nb">puts</span> <span class="s2">"Name?"</span>
  <span class="nb">name</span> <span class="o">=</span> <span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="nb">puts</span> <span class="s2">"Birthdate?"</span>
  <span class="n">birthdate</span> <span class="o">=</span> <span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="nb">puts</span> <span class="s2">"Gender?"</span>
  <span class="n">gender</span> <span class="o">=</span> <span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span>
  <span class="nb">puts</span> <span class="s2">"Title?"</span>
  <span class="n">title</span> <span class="o">=</span> <span class="nb">gets</span><span class="p">.</span><span class="nf">chomp</span>

  <span class="n">new_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">add_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Name is required"</span><span class="p">]</span>                  <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">))</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Birthdate is required"</span><span class="p">]</span>             <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">))</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Gender is required"</span><span class="p">]</span>                <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">))</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Gender must be 'male' or 'female'"</span><span class="p">]</span> <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">'male'</span> <span class="o">&amp;&amp;</span> 
                                                      <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">'female'</span>

  <span class="nb">id</span> <span class="o">=</span> <span class="n">insert_person</span><span class="o">.</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span>
  <span class="p">[</span><span class="n">new_person</span><span class="o">.</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:title</span><span class="p">),</span><span class="nb">id</span><span class="p">),</span><span class="kp">nil</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">get_new_person</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span>
  <span class="n">handle_result</span><span class="o">.</span><span class="p">(</span><span class="n">add_person</span><span class="o">.</span><span class="p">(</span><span class="n">read_person_from_user</span><span class="o">.</span><span class="p">()),</span>
    <span class="o">-&gt;</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">puts</span> <span class="s2">"Successfully added person </span><span class="si">#{</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">person</span>
    <span class="p">},</span> 
    <span class="o">-&gt;</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">puts</span> <span class="s2">"Problem: </span><span class="si">#{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">get_new_person</span><span class="o">.</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">add_person</code> is a bit noisier, due to the syntax of getting an attribute, but we can now add new fields very easily and keep things structured.</p>

<h2 id="object-orientation-is-just-functions">Object-orientation is just functions</h2>

<p>We can also add derived fields.  Suppose we want a saluation for the person that uses their title?  We can make that an attribute of the person:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>new_person = -&gt;(name,birthdate,gender,title,id) {
  return -&gt;(attribute) {
    return id        if attribute == :id
    return name      if attribute == :name
    return birthdate if attribute == :birthdate
    return gender    if attribute == :gender
    return title     if attribute == :title
    if attribute == :salutation
      if String(title) == ''
        return name
      else
        return title + " " + name
      end
    end
    nil
  }
}
</code></pre>
</div>

<p>Heck, we can create full-on OO-style <em>methods</em> if we wanted to:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">new_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">id</span>        <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:id</span>
    <span class="k">return</span> <span class="nb">name</span>      <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:name</span>
    <span class="k">return</span> <span class="n">birthdate</span> <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:birthdate</span>
    <span class="k">return</span> <span class="n">gender</span>    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:gender</span>
    <span class="k">return</span> <span class="n">title</span>     <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:title</span>
    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:salutation</span>
      <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">==</span> <span class="s1">''</span>
        <span class="k">return</span> <span class="nb">name</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="n">title</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="nb">name</span>
      <span class="k">end</span>
    <span class="k">elsif</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:update</span>
      <span class="n">update_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:destroy</span>
      <span class="n">delete_person</span><span class="o">.</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="kp">nil</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">some_person</span><span class="o">.</span><span class="p">(</span><span class="ss">:update</span><span class="p">)</span>
<span class="n">some_person</span><span class="o">.</span><span class="p">(</span><span class="ss">:destroy</span><span class="p">)</span>
</code></pre>
</div>

<p>While we’re at it, let’s add inheritance!  Suppose we have an employee that is a person, but with an employee id number:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">new_employee</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">employee_id_number</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">person</span> <span class="o">=</span> <span class="n">new_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
  <span class="k">return</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">employee_id_number</span> <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:employee_id_number</span>
    <span class="k">return</span> <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>We’ve created classes, objects, and inheritance, all with just functions, and in just a few lines of code.</p>

<p>In a sense, an object in an OO language is a set of functions that have access to a shared set of data.  It’s not hard to see why adding an object system to a functional
language is considered trivial by those knoweldgable in functional languages.  It’s certainly a lot easier than adding functions to an object-oriented language!</p>

<p>Although the syntax for accessing attributes is a bit clunky, I’m not feeling a <em>ton</em> of pain by not having classes.  Classes seem almost like syntactic sugar at this point,
rather than some radical concept.</p>

<p>One thing that seems problematic is mutation.  Look at how verbose <code class="highlighter-rouge">add_person</code> is.  It calls <code class="highlighter-rouge">insert_person</code> to put our person into the database, and
gets an ID back.  We then have to create an entirely new person just to set the ID.  In classic OO, we’d just do <code class="highlighter-rouge">person.id = id</code>.</p>

<p>Is mutable state what’s nice about this construct?  I’d argue that its compactness is what’s nice, and the fact that this compactness is implemented via mutable state is just
incidental.  Unless we are in a severely memory-starved environment, with terrible garbage collection, we aren’t going to be concerned about making new objects.  We <em>are</em> going
to be annoyed by the needless repetition of building new objects from scratch.  Since we already know how to add functions to our, er, function, let’s add one to bring back
this compact syntax.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">new_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">id</span>        <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:id</span>
    <span class="k">return</span> <span class="nb">name</span>      <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:name</span>
    <span class="k">return</span> <span class="n">birthdate</span> <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:birthdate</span>
    <span class="k">return</span> <span class="n">gender</span>    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:gender</span>
    <span class="k">return</span> <span class="n">title</span>     <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:title</span>
    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:salutation</span>
      <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">==</span> <span class="s1">''</span>
        <span class="k">return</span> <span class="nb">name</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="n">title</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="nb">name</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="ss">:with_id</span> <span class="c1"># &lt;===</span>
      <span class="k">return</span> <span class="n">new_person</span><span class="o">.</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="n">gender</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="kp">nil</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now, <code class="highlighter-rouge">add_person</code> is even simpler:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">add_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Name is required"</span><span class="p">]</span>                  <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">))</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Birthdate is required"</span><span class="p">]</span>             <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">))</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Gender is required"</span><span class="p">]</span>                <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">))</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Gender must be 'male' or 'female'"</span><span class="p">]</span> <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">'male'</span> <span class="o">&amp;&amp;</span> 
                                                      <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">'female'</span>

  <span class="nb">id</span> <span class="o">=</span> <span class="n">insert_person</span><span class="o">.</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">),</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span>
  <span class="p">[</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:with_id</span><span class="p">,</span><span class="nb">id</span><span class="p">),</span><span class="kp">nil</span><span class="p">]</span> <span class="c1"># &lt;====</span>
<span class="p">}</span>
</code></pre>
</div>

<p>It’s not quite as clean as <code class="highlighter-rouge">person.id = id</code>, but it’s terse enough that it’s still readable, and the code is better for it.</p>

<h2 id="namespaces-are-just-functions">Namespaces are just functions</h2>

<p>What I’m really missing is namespaces.  If you’ve done any C programming, you know that your code becomes littered with functions that have complex prefixes to avoid
name-clashes.  We could certainly do that here, but it would be nice to have proper namespacing, like we get via modules in Ruby or object literals in JavaScript.
We’d like to add this without adding a feature to our language.  The simplest way to do that is to implement some sort of map.  We can already get explicit attributes
of a data structure, so we just need a more generic way to do so.</p>

<p>Currently, the only data structure we have is an array, and we don’t have methods, since we don’t have classes.  The arrays we have are really tuples, and the only general
operations we have are the ability to extract data from them.  For example:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">first</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">((</span><span class="n">f</span><span class="p">,</span><span class="o">*</span><span class="n">rest</span><span class="p">))</span> <span class="p">{</span> <span class="n">f</span>    <span class="p">}</span> <span class="c1"># or should I name this car? :)</span>
<span class="n">rest</span>  <span class="o">=</span> <span class="o">-&gt;</span><span class="p">((</span><span class="n">f</span><span class="p">,</span><span class="o">*</span><span class="n">rest</span><span class="p">))</span> <span class="p">{</span> <span class="n">rest</span> <span class="p">}</span>
</code></pre>
</div>

<p>We can model a map as a list, by treating it as a list with three entires: the key, the value, and the rest of the map.  Let’s avoid the “OO style” of making “methods” and
just keep it pureful functional:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">empty_map</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">add</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">[</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">map</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">get</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">map</span> <span class="o">==</span> <span class="kp">nil</span>
  <span class="k">return</span> <span class="n">map</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span>
  <span class="k">return</span> <span class="n">get</span><span class="o">.</span><span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">key</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p>We can use it like so:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">map</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="p">(</span><span class="n">empty_map</span><span class="p">,</span><span class="ss">:foo</span><span class="p">,</span><span class="ss">:bar</span><span class="p">)</span>
<span class="n">map</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="ss">:baz</span><span class="p">,</span><span class="ss">:quux</span><span class="p">)</span>
<span class="n">get</span><span class="o">.</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="ss">:foo</span><span class="p">)</span>  <span class="c1"># =&gt; :bar</span>
<span class="n">get</span><span class="o">.</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="ss">:baz</span><span class="p">)</span>  <span class="c1"># =&gt; :quux</span>
<span class="n">get</span><span class="o">.</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="ss">:blah</span><span class="p">)</span> <span class="c1"># =&gt; nil</span>
</code></pre>
</div>

<p>This is enough to namepsace things:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">people</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="p">(</span><span class="n">empty_map</span> <span class="p">,</span><span class="ss">:insert</span> <span class="p">,</span><span class="n">insert_person</span><span class="p">)</span>
<span class="n">people</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="p">(</span><span class="n">people</span>    <span class="p">,</span><span class="ss">:update</span> <span class="p">,</span><span class="n">update_person</span><span class="p">)</span>
<span class="n">people</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="p">(</span><span class="n">people</span>    <span class="p">,</span><span class="ss">:delete</span> <span class="p">,</span><span class="n">delete_person</span><span class="p">)</span>
<span class="n">people</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="p">(</span><span class="n">people</span>    <span class="p">,</span><span class="ss">:fetch</span>  <span class="p">,</span><span class="n">fetch_person</span><span class="p">)</span>
<span class="n">people</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="p">(</span><span class="n">people</span>    <span class="p">,</span><span class="ss">:new</span>    <span class="p">,</span><span class="n">new_person</span><span class="p">)</span>

<span class="n">add_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Name is required"</span><span class="p">]</span>                  <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">))</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Birthdate is required"</span><span class="p">]</span>             <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">))</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Gender is required"</span><span class="p">]</span>                <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">))</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Gender must be 'male' or 'female'"</span><span class="p">]</span> <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">'male'</span> <span class="o">&amp;&amp;</span> 
                                                      <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">'female'</span>

  <span class="nb">id</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">people</span><span class="p">,</span><span class="ss">:insert</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">),</span>
                            <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">),</span>
                            <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">),</span>
                            <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span>

  <span class="p">[</span><span class="n">get</span><span class="p">(</span><span class="n">people</span><span class="p">,</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="ss">:with_id</span><span class="p">,</span><span class="nb">id</span><span class="p">),</span><span class="kp">nil</span><span class="p">]</span>
<span class="p">}</span>
</code></pre>
</div>

<p>We could certainly replace our <code class="highlighter-rouge">new_person</code> implementation with a map, but it’s nice to have an explicit list of attributes that we support, so we’ll leave <code class="highlighter-rouge">new_person</code> as-is.</p>

<p>One last bit of magic.  <code class="highlighter-rouge">include</code> is a nice feature of Ruby; it lets us bring modules into scope to avoid using the namespace.  Can we do that here?  We can get close:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">include_namespace</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">code</span><span class="o">.</span><span class="p">(</span><span class="o">-&gt;</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span> <span class="n">get</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span><span class="n">key</span><span class="p">)</span> <span class="p">})</span>
<span class="p">}</span>

<span class="n">add_person</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Name is required"</span><span class="p">]</span>                  <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">))</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Birthdate is required"</span><span class="p">]</span>             <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">))</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Gender is required"</span><span class="p">]</span>                <span class="k">if</span> <span class="no">String</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">))</span> <span class="o">==</span> <span class="s1">''</span>
  <span class="k">return</span> <span class="p">[</span><span class="kp">nil</span><span class="p">,</span><span class="s2">"Gender must be 'male' or 'female'"</span><span class="p">]</span> <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">'male'</span> <span class="o">&amp;&amp;</span> 
                                                      <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">'female'</span>

  <span class="n">include_namespace</span><span class="p">(</span><span class="n">people</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="ss">:insert</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:name</span><span class="p">),</span>
                     <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">),</span>
                     <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:gender</span><span class="p">),</span>
                     <span class="n">person</span><span class="o">.</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span>

    <span class="p">[</span><span class="n">_</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="ss">:with_id</span><span class="p">,</span><span class="nb">id</span><span class="p">),</span><span class="kp">nil</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>OK, this might be over the top, but it’s fairly interesting to think of something like <code class="highlighter-rouge">include</code> as just a way to “type less stuff”, and that we can achieve a similar
reduction in “typing stuff” by just using functions.</p>

<h2 id="what-have-we-learned">What have we learned?</h2>

<p>With just a few basic language constructs, we can create a fairly usable programming language.  We can create bona-fide types, namespaces, and even
do object-oriented programming, without any explicit support for these features.  And we can do so in more or less the same amount of code that would be required
by using Ruby’s built-in support.  The syntax is <em>slightly</em> verbose compared to the full-blown Ruby equivalent, but it’s not
<em>that</em> bad.  We could write real code using this degenerate form of Ruby, and it wouldn’t be too bad.</p>

<p>Does this help us in our everyday work?  I think this is a lesson in simplicity.  Ruby is fraught with DSLs, abused syntax, and meta-programming, yet we’ve just
been able to accomplish a lot without even using classes!  Perhaps the problem you have in front of you can be solved by something simple?  Perhaps you don’t
need anything fancy, but can rely on the more straightforward parts of your language.</p>

  </section>
</article>
</div>

    </section>
  </main>
  <footer class="center">
    <p class="f6">
      Copyright &copy; 2006-2017, by David Bryant Copeland, All Rights Reserved
    </p>
  </footer>
  <script type="text/javascript">
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '56a22cd9c88d90284f000861');
      t.setAttribute('data-track-path', 'https://track.gaug.es/track.gif');
      t.src = 'https://d36ee2fcip1434.cloudfront.net/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  </script>
</body></html>
