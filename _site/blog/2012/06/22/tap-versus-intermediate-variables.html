
<!DOCTYPE html>
<html language="en"><head>
  <meta charset="utf-8">
  <title>Tap versus intermediate variables - naildrivin5.com - David Bryant Copeland's Website</title>
  <meta name="author" content="David Bryant Copeland">
  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/images/favicons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/images/favicons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/images/favicons/ms-icon-144x144.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  

  
  <meta name="description" content="

  
    Tap versus intermediate variables
    
      June 22, 2012
    
  
  
    In my Ruby style guide, I mention the preference for using Ruby’...">
  

  
  <link rel="canonical" href="http://naildrivin5.com/blog/2012/06/22/tap-versus-intermediate-variables.html">
  <link href="/favicon.png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="naildrivin5.com - David Bryant Copeland's Website" type="application/atom+xml">
  <link href="/css/styles.css" rel="stylesheet">
  <script src="https://use.typekit.net/ylm4zpa.js"></script>
  <script>try{Typekit.load({ async: true });}catch(e){}</script>
            
  <meta name="google-site-verification" content="h_yTpXa6N3ebHj8DYmgX4lIFGHBW1NtGMVHfXuu7i_4" />
</head>
<body>
  <header class="site-header pb2 mb2 center">
    <h1 class="uc ls2 f1"><a href="/">naildrivin5.com</a></h1>
    <h2 class="ls1"><small class="uc h4">Website of</small> David Bryant Copeland</h2>
    <nav>
      <ul>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/">Blog</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/bio">About</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/books">Books</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/talks">Talks</a></li>
      </ul>
      <div style="clear: both"></div>
    </nav>
  </header>
  <main>
    <section>
      <div>
<article role="article" class="blog-post">
  <header class="border-bottom border-light">
    <h1>Tap versus intermediate variables</h1>
    <h2 class="f5 ls2 fw-bold mtnone uc ib">
      June 22, 2012
    </h2>
  </header>
  <section class="blog-content">
    <p>In my <a href="http://davetron5000.github.com/ruby-style">Ruby style guide</a>, I mention the preference for using Ruby’s <code class="highlighter-rouge">tap</code>:</p>

<blockquote>
  <p>When you must mutate an object before returning it, avoid creating intermediate objects and use tap:</p>
</blockquote>

<p>I thought it might be interesting to expand on this.</p>

<!-- more -->

<h2 id="what-is-tap">What is <code class="highlighter-rouge">tap</code>?</h2>

<p>First off, <code class="highlighter-rouge">tap</code> is a method on <code class="highlighter-rouge">Object</code> that takes a block, which is passed itself, and evaluates to itself.  Whoa.</p>

<p><code class="highlighter-rouge">ruby
class Object
  # Imagined implementation
  def tap(&amp;block)
    block.call(self)
    self
  end
end
</code></p>

<p>An interesting use of <code class="highlighter-rouge">tap</code> is when debugging a <a href="http://en.wikipedia.org/wiki/Law_of_Demeter">Law of Demeter</a> violation:</p>

<p>```ruby
# before
@person.parents.first.nag(:are_we_there_yet?)</p>

<h1 id="after">after</h1>
<p>@person.parents.tap { |parents| puts parents.inspect }.first.nag(:are_we_there_yet?)
```</p>

<p>No matter what happens inside of the block you give to <code class="highlighter-rouge">tap</code>, the call always evaluates to the object itself.  We don’t change the string of calls, but can inject code into it.</p>

<p>This is not the power of <code class="highlighter-rouge">tap</code> in my opinion.  I use <code class="highlighter-rouge">tap</code> when:</p>

<ul>
  <li>I’m writing a method that creates and returns an object</li>
  <li>I must modify or call methods on that object before returning it</li>
</ul>

<h2 id="intermediate-variable-elimination-front">Intermediate Variable Elimination Front</h2>

<p>From <a href="http://www.naildrivin5.com/blog/2012/06/10/single-responsibility-principle-and-rails.html">my last blog post</a>, I had this method:</p>

<p><code class="highlighter-rouge">ruby
def create_new_user(params)
  User.create(params).tap { |new_user|
    if new_user.valid?
      UserMailer.deliver_welcome_email(new_user)
    end
  }
end
</code></p>

<p>Between creating the user and returning it, I needed to do some other stuff, so I create a scope in which to do it with <code class="highlighter-rouge">tap</code>.</p>

<p>The classic approach is to use an intermediate variable for the new user and looks like so:</p>

<p><code class="highlighter-rouge">ruby
def create_new_user(params)
  new_user = User.create(params)
  if new_user.valid?
    UserMailer.deliver_welcome_email(new_user)
  end
  new_user
end
</code></p>

<p>Same lines of code, so why is the <code class="highlighter-rouge">tap</code> version better?</p>

<p>From my style guide<a name="back-1"></a><sup><a href="#1">1</a></sup>:</p>

<blockquote>
  <p>Intermediate objects increase the mental requirements for understanding a routine. <code class="highlighter-rouge">tap</code> also creates a nice scope in which the object is being mutated; you will not forget to return the object when you change the code later</p>
</blockquote>

<p>Let’s look at our intermediate routine again, this time, marking a few places in the code</p>

<p><code class="highlighter-rouge">ruby
def create_new_user(params)
  new_user = User.create(params)
  if new_user.valid?
    UserMailer.deliver_welcome_email(new_user)
  end
  # 1
  new_user
  # 2
end
</code></p>

<ol>
  <li>Here is where any new code should be added to this method.</li>
  <li>Here is where you might add new code that will cause this method to break</li>
</ol>

<p>A developer’s instinct is to add new code “at the bottom”.  In the “intermediate variables” version, the last line is special, so
you have to add code on the <em>second to last line</em>.</p>

<p>But, isn’t that the same in the <code class="highlighter-rouge">tap</code> version?  No, because <code class="highlighter-rouge">tap</code> creates a scope, visually and literally.</p>

<p><code class="highlighter-rouge">ruby
def create_new_user(params)
  User.create(params).tap { |new_user|
    if new_user.valid?
      UserMailer.deliver_welcome_email(new_user)
    end
    # 1
  }
end
</code></p>

<p>The location of #1 is logically “the bottom”, because it’s the end of the scope in question, and thus where you are more
likely to put new code.  It <em>also</em> alleviates you from having to worry about making sure that <code class="highlighter-rouge">new_user</code> is the last thing
evaluated; <code class="highlighter-rouge">tap</code> handles that.  No matter what new code you add, the new user is always returned.</p>

<p>I find this simple little thing makes certain routines easier to understand and modify.</p>

<h2 id="appendix-what-if-i-dont-write-ruby-code">Appendix: What if I don’t write Ruby code?</h2>

<p>In Scala, this can be achieved using implicits:</p>

<p>```scala
object Tapper {
  implicit def anyToTapper<a href="obj: A">A</a> = new Tapper(obj)
}</p>

<p>class Tapper<a href="obj: A">A</a> {
  def tap(code: A =&gt; Unit): A = {
    code(obj)
    obj
  }
}</p>

<p>import Tapper._</p>

<p>new User(params).tap { newUser =&gt;
  if (newUser.isValid) {
    UserMailer.deliverWelcomeEmail(newUser)
  }
}
```</p>

<p>In JavaScript, you can just put it on <code class="highlighter-rouge">Object</code>:</p>

<p>```javascript
Object.prototype.tap = function(block) { block(this); return this; };</p>

<p>function createNewUser(params) {
  return new User(params).tap( function(newUser) {
    if (newUser.isValid()) {
      new UserMailer().deliverWelcomeEmail(newUser);
    }
  });
}
```</p>

<p>In Java, you’re screwed, but just for fun, let’s try:</p>

<p>```java
public interface TapFunction<t> {
  void apply(T object);
}</t></p>

<p>public class Tapper {
  public static <t> T tap(T object, TapFunction<t> function) {
    function.apply(object);
    return object;
  }
}</t></t></p>

<p>import static Tapper.tap;</p>

<p>public void createNewUser(Map&lt;String,?&gt; params) {
  tap(new User(params),new TapFunction<user>() {
    public void apply(User newUser) {
      if (newUser.isValid()) {
        UserMailer.deliverWelcomeEmail(newUser);
      }
    }
  });
}
```</user></p>

<p>Not exactly a huge win in Java :)  Now, who’ll write this in C?</p>

<hr />

<footer class="footnotes">
<ol>
<li>
<a name="1"></a>
<sup>1</sup>It's a great exercise to create a style guide and then explain <em>why</em> you follow a particular rule.  You might be surprised at the number of “I just like how it looks” reasons.<a href="#back-1">↩</a>
</li>
</ol></footer>


  </section>
</article>
</div>

    </section>
  </main>
  <footer class="center">
    <p class="f6">
      Copyright &copy; 2006-2016, by David Bryant Copeland, All Rights Reserved
    </p>
  </footer>
  <script type="text/javascript">
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '56a22cd9c88d90284f000861');
      t.setAttribute('data-track-path', 'https://track.gaug.es/track.gif');
      t.src = 'https://d36ee2fcip1434.cloudfront.net/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  </script>
</body></html>
