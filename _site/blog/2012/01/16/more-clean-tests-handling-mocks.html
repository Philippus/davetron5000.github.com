
<!DOCTYPE html>
<html language="en"><head>
  <meta charset="utf-8">
  <title>More Clean Tests: Handling Mocks &amp; Block-based asserts - naildrivin5.com - David Bryant Copeland's Website</title>
  <meta name="author" content="David Bryant Copeland">
  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/images/favicons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/images/favicons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/images/favicons/ms-icon-144x144.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  

  
  <meta name="description" content="

  
    More Clean Tests: Handling Mocks &amp; Block-based asserts
    
      January 16, 2012
    
  
  
    In a previous post, I talked
about t...">
  

  
  <link rel="canonical" href="http://naildrivin5.com/blog/2012/01/16/more-clean-tests-handling-mocks.html">
  <link href="/favicon.png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="naildrivin5.com - David Bryant Copeland's Website" type="application/atom+xml">
  <link href="/css/styles.css" rel="stylesheet">
  <script src="https://use.typekit.net/ylm4zpa.js"></script>
  <script>try{Typekit.load({ async: true });}catch(e){}</script>
            
  <meta name="google-site-verification" content="h_yTpXa6N3ebHj8DYmgX4lIFGHBW1NtGMVHfXuu7i_4" />
</head>
<body>
  <header class="site-header pb2 mb2 center">
    <h1 class="uc ls2 f1"><a href="/">naildrivin5.com</a></h1>
    <h2 class="ls1"><small class="uc h4">Website of</small> David Bryant Copeland</h2>
    <nav>
      <ul>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/">Blog</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/bio">About</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/books">Books</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/talks">Talks</a></li>
      </ul>
      <div style="clear: both"></div>
    </nav>
  </header>
  <main>
    <section>
      <div>
<article role="article" class="blog-post">
  <header class="border-bottom border-light">
    <h1>More Clean Tests: Handling Mocks &amp; Block-based asserts</h1>
    <h2 class="f5 ls2 fw-bold mtnone uc ib">
      January 16, 2012
    </h2>
  </header>
  <section class="blog-content">
    <p>In a <a href="http://www.naildrivin5.com/blog/2012/01/08/make-tests-clean-and-clear-without-duplication.html">previous post</a>, I talked
about the overall structure of a test and how that was important to understand the test itself.  A brief review:</p>

<ul>
  <li><em>Given</em> - Establish the conditions under which the test will run</li>
  <li><em>When</em> - Run the code under test</li>
  <li><em>Then</em> - assert that the code did what you expect</li>
</ul>

<p>This structure becomes problematic when using either mock objects or block-based asserts.</p>

<!-- more -->

<h2 id="the-trouble-with-mocks">The Trouble with Mocks</h2>

<p>When using <a href="http://en.wikipedia.org/wiki/Mock_object">mock objects</a> in a test, you typically use a
mocking framework (like <a href="http://mocha.rubyforge.org/">mocha</a>) to modify the behavior of objects the class-under-test collaborates with.
You often test that the class-under-test made certain calls to its collaborators.  Let’s look at an example.</p>

<p>Suppose we have an existing system and we wish to start recording some statistics, such as the number of times a method is called
or how long a method takes to run.  We’ve created a class, <code class="highlighter-rouge">Statistics</code>, that has some class methods on it to do the recording:</p>

<p><code class="highlighter-rouge">ruby
class Statistics
  # Add one to stat_name
  def self.count(stat_name)
    # ...
  end
end
</code></p>

<p>We want to start using this class in our <code class="highlighter-rouge">Salutation</code> class to keep track of the number of times we’re calling <code class="highlighter-rouge">#greeting</code>.
In order to add this in, we need to test that <code class="highlighter-rouge">Salutation#greeting</code> is calling <code class="highlighter-rouge">Statistics.count</code>.  While we could set up a fake
statistics server and examine it during our test, it’s more straightforward to use mocks.</p>

<p><code class="highlighter-rouge">ruby
class SalutationTest &lt;&lt; TestCase
  def test_that_we_log_statistics
    saluation = Salutation.new(Person.new('David','Copeland',:male))
    Statistics.expects(:count).with('saluation.greeting.count')
    saluation.greeting
  end
end
</code></p>

<p>What will happen is, if we don’t call <code class="highlighter-rouge">Statistics.count("saluation.greeting.count")</code> in the <code class="highlighter-rouge">Salutation</code> class, this test will
fail.  That’s what a mocking framework like mocha does for us.</p>

<p>Of course, there’s something odd about our test.  There’s no call to any sort of <code class="highlighter-rouge">assert</code> method.  The Given/When/Then is very
unclear.  For a real-world test that requires a lot more setup, it can be even more difficult to see what’s actually being
tested.  Essentially, the “Given/When/Then” is “out of order”:</p>

<p><code class="highlighter-rouge">ruby
class SalutationTest &lt;&lt; TestCase
  def test_that_we_log_statistics
    # Given
    saluation = Salutation.new(Person.new('David','Copeland',:male))
    # Then
    Statistics.expects(:count).with('saluation.greeting.count')
    # When
    saluation.greeting
  end
end
</code></p>

<h2 id="making-our-intent-clear">Making our Intent Clear</h2>

<p>We’d like to keep our test method in a canonical structure, or at least have some part of it follow the Given/When/Then
structure.  Unfortunately, our “Then”, the mock expectations, simply <em>have</em> to occur <em>before</em> the “When”.  I think
we can make it clearer, so let’s add a bit of code to help.</p>

<p>First, we’ll create a method named <code class="highlighter-rouge">when_the_test_runs_then</code> to clearly indicate that our expectations
are part of our “Then”, and that they are going to be checked when the test runs, which happens later.  We’ll also add a no-op
method, <code class="highlighter-rouge">assert_mocks_were_called</code> that will allow our test to always have an assert and provide us with a way to be explicit
about what’s being asserted.  Although this “assert” method doesn’t do anything, it allows use to distinguish between “this test
passes when the mocks are called as expected” from “I forgot to actually test for something”.</p>

<p>```ruby
class SalutationTest « TestCase
  def test_that_we_log_statistics
    when_the_test_runs_then {
      Statistics.expects(:count).with(‘saluation.greeting.count’)
    }</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Given
saluation = Salutation.new(Person.new('David','Copeland',:male))
# When
saluation.greeting
# Then
assert_mocks_were_called   end
</code></pre>
</div>

<p>def when_the_test_runs_then; yield; end
  def assert_mocks_were_called; end
end
```</p>

<p>We’ve still deviated from our canonical structure, but the test <em>reads</em> better: “When the test runs then expect this method to be
called; now let’s run the test”</p>

<p>Of course, we’ve just taken our first step out of “plain old Ruby” and created framework code.  This is the price you pay for
using mocks; testing with mocks complicate our tests.   By using some lightweight “control structure” helper methods, we can at
least make the intent clear.</p>

<h2 id="block-based-asserts-disrupt-too">Block-Based Asserts Disrupt, too</h2>

<p>There’s another pattern we see in tests that disrupts the structure in much the same way that the use of mocks does.  That
disruption is block-based asserts, the most common of which is <code class="highlighter-rouge">assert_raises</code>.  For example, suppose we’re testing that our
<code class="highlighter-rouge">Saluation</code> class requires a non-<code class="highlighter-rouge">nil</code> <code class="highlighter-rouge">Person</code> in its constructor.  We could test that like so:</p>

<p><code class="highlighter-rouge">ruby
def test_that_constructor_requires_a_person
  assert_raises ArgumentError do
    Salutation.new(nil)
  end
end
</code></p>

<p>This test is weird for two reasons: the first is that the “Given” is implicit.  The second is that the “Then” comes before the
“When”:</p>

<p><code class="highlighter-rouge">ruby
def test_that_constructor_requires_a_person
  # Given - we are going to use a nil Person
  # Then
  assert_raises ArgumentError do
    # When
    Salutation.new(nil)
  end
end
</code></p>

<p>We can clean this up by creating a variable for our <code class="highlighter-rouge">nil</code> <code class="highlighter-rouge">Person</code> and putting our “Then” code inside a block, which we then pass
to <code class="highlighter-rouge">assert_raises</code>:</p>

<p><code class="highlighter-rouge">ruby
def test_that_constructor_requires_a_person
  # Given
  nil_person = nil
  # When
  code = lambda { Salutation.new(nil_person) }
  # Then
  assert_raises(ArgumentError,&amp;code)
end
</code></p>

<p>We’ve had to jump through a slightly awkward hoop of putting the code-under-test in a lambda, but now things are in a consistent
structure.  This example might seem a bit too simplisitc.  What about another popular block-based assertion, <code class="highlighter-rouge">assert_difference</code>?
It’s commonly used in Rails apps to check that a certain number of records were written to the database.  While I think that this
assertion is generally not needed, it is commonly used.<br />
Here’s an example where we suppose that an <code class="highlighter-rouge">after_save</code> hook is memoizing a
derived field for us.</p>

<p>```ruby
test “we can save and our after-save hook runs, generating the full_name attribute” do
  # Given
  first_name = ‘David’
  last_name = ‘Copeland’</p>

<p># Then
  assert_difference(‘Person.count’) do
    # When
    person = Person.create(:first_name =&gt; first_name, last_name =&gt; last_name)
    # Then
    assert ‘David Copeland’,person.full_name
  end
end
```</p>

<p><em>Now</em> the structure is very strange.  If we try to apply our <code class="highlighter-rouge">lambda</code> solution above, it’s still a bit odd:</p>

<p>```ruby
test “we can save and our after-save hook runs, generating the full_name attribute” do
  # Given
  first_name = ‘David’
  last_name = ‘Copeland’</p>

<p># When
  code = lambda {
    person = Person.create(:first_name =&gt; first_name, last_name =&gt; last_name)
    # Then
    assert ‘David Copeland’,person.full_name
  }</p>

<p># Then
  assert_difference(‘Person.count’,&amp;code)
end
```</p>

<p>Yikes.  This is arguably worse.  Since only one line of code inside our “When” block is really affecting the condition that
<code class="highlighter-rouge">assert_difference</code> tests for, we can take advantage of Ruby’s ability to create instance variables on-demand and pass
the person outside of the <code class="highlighter-rouge">assert_difference</code> block:</p>

<p>```ruby
test “we can save and our after-save hook runs, generating the full_name attribute” do
  # Given
  first_name = ‘David’
  last_name = ‘Copeland’</p>

<p># When
  create_person = lambda { 
    @person = Person.create(:first_name =&gt; first_name, last_name =&gt; last_name)
  }</p>

<p># Then
  assert_difference(‘Person.count’,&amp;create_person)
  assert ‘David Copeland’,@person.full_name
end
```</p>

<p>That’s much better; we can now clearly see the setup, the code being tested, and all the assertions together.</p>

<p>It may seem slightly unusual, but by working to keep all your tests structured around Given/When/Then, you will find them
readable weeks and months later, and others will be clearly able to see their intent.</p>

<h2 id="next">Next</h2>

<p>We still have a fair way to go to get our tests really clean and clear.  For example, do we need to have those <code class="highlighter-rouge">#Given</code>, <code class="highlighter-rouge">#When</code>,
and <code class="highlighter-rouge">#Then</code> comments
everywhere?  I <a href="http://www.naildrivin5.com/blog/2012/01/11/the-war-on-comments.html">think comments are powerful</a>, but having the same group of comments everywhere 
feels like repetition we can eliminate.
Another issue is the use of “magic values”, or literals, in our test code.  In the test above, we create a male person with the
name “David Copeland”.  Is any of this relevant to the test?  If not, why is it there?</p>

<p>We’ll deal with these issues in the next post.</p>


  </section>
</article>
</div>

    </section>
  </main>
  <footer class="center">
    <p class="f6">
      Copyright &copy; 2006-2016, by David Bryant Copeland, All Rights Reserved
    </p>
  </footer>
  <script type="text/javascript">
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '56a22cd9c88d90284f000861');
      t.setAttribute('data-track-path', 'https://track.gaug.es/track.gif');
      t.src = 'https://d36ee2fcip1434.cloudfront.net/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  </script>
</body></html>
