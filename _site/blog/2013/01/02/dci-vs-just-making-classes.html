
<!DOCTYPE html>
<html language="en"><head>
  <meta charset="utf-8">
  <title>DCI vs Just Making Classes - naildrivin5.com - David Bryant Copeland's Website</title>
  <meta name="author" content="David Bryant Copeland">
  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/images/favicons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/images/favicons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/images/favicons/ms-icon-144x144.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  

  
  <meta name="description" content="

  
    DCI vs Just Making Classes
    
      January 02, 2013
    
  
  
    There’s been lots of talk about DCI in the Ruby community lately.  A...">
  

  
  <link rel="canonical" href="http://naildrivin5.com/blog/2013/01/02/dci-vs-just-making-classes.html">
  <link href="/favicon.png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="naildrivin5.com - David Bryant Copeland's Website" type="application/atom+xml">
  <link href="/css/styles.css" rel="stylesheet">
  <script src="https://use.typekit.net/ylm4zpa.js"></script>
  <script>try{Typekit.load({ async: true });}catch(e){}</script>
            
  <meta name="google-site-verification" content="h_yTpXa6N3ebHj8DYmgX4lIFGHBW1NtGMVHfXuu7i_4" />
</head>
<body>
  <header class="site-header pb2 mb2 center">
    <h1 class="uc ls2 f1"><a href="/">naildrivin5.com</a></h1>
    <h2 class="ls1"><small class="uc h4">Website of</small> David Bryant Copeland</h2>
    <nav>
      <ul>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/">Blog</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/bio">About</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/books">Books</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/talks">Talks</a></li>
      </ul>
      <div style="clear: both"></div>
    </nav>
  </header>
  <main>
    <section>
      <div>
<article role="article" class="blog-post">
  <header class="border-bottom border-light">
    <h1>DCI vs Just Making Classes</h1>
    <h2 class="f5 ls2 fw-bold mtnone uc ib">
      January 02, 2013
    </h2>
  </header>
  <section class="blog-content">
    <p>There’s been lots of talk about <a href="http://en.wikipedia.org/wiki/Data,_Context,_and_Interaction">DCI</a> in the Ruby community lately.  As I mentioned, I am only partway through Jim
Gay’s <a href="http://clean-ruby.com">unfinished book on the subject</a>, but I ran across a blog post that had a more substantial example in it.</p>

<p>Titled <a href="http://rebo.ruhoh.com/why-dci-contexts/">Why DCI Contexts?</a>, someone named <a href="http://rebo.ruhoh.com/about/">rebo</a>, shows a starting point of “normal” code, then “DCIzes” it, then walks through adding new features to the system.  It’s a bit long, but his explanation is great, and it shows a <em>lot</em> more than just calling <code class="highlighter-rouge">.extend</code> on an object - he clearly demonstrates how roles and contexts are used to implement specific use cases.</p>

<p>Despite the deftness of his explalnation, I find the result code entirely too complex, thanks to confusing abstractions, a
needless DSL and leaky abstractions.  It would all have been a lot simpler if he Just Used Classes®</p>

<p>Let’s see why.</p>

<!-- more -->

<p>In rebo’s post, he has a basic domain of a <code class="highlighter-rouge">User</code>, a <code class="highlighter-rouge">Product</code>, an <code class="highlighter-rouge">Invoice</code>, and <code class="highlighter-rouge">Accounts</code> (which groups invoices).  The classes he creates for them are reasonable structs - they just hold data and have no real methods.  He then shows the implementation of a basic use case - when someone buys something an invoice is created and added to their accounts.  Here’s the code.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PurchasingProcess</span>
  <span class="kp">include</span> <span class="no">AliasDCI</span><span class="o">::</span><span class="no">Context</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">accounts</span><span class="p">)</span>
    <span class="n">assign_named_roles</span><span class="p">(</span><span class="ss">:customer</span>            <span class="o">=&gt;</span> <span class="n">user</span><span class="p">,</span>
                       <span class="ss">:selected_product</span>    <span class="o">=&gt;</span> <span class="n">product</span><span class="p">,</span>
                       <span class="ss">:accounts_department</span> <span class="o">=&gt;</span> <span class="n">accounts</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span>
    <span class="n">in_context</span> <span class="k">do</span>
      <span class="n">customer</span><span class="p">.</span><span class="nf">buy_product</span>
      <span class="n">accounts_department</span><span class="p">.</span><span class="nf">generate_invoice</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">role</span> <span class="ss">:customer</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">buy_product</span>
      <span class="n">purchases</span> <span class="o">&lt;&lt;</span> <span class="n">selected_product</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">role</span> <span class="ss">:selected_product</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">invoice_desc</span>
      <span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> - </span><span class="si">#{</span><span class="n">description</span><span class="si">}</span><span class="s2"> @ </span><span class="si">#{</span><span class="n">price</span><span class="si">}</span><span class="s2"> ea."</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">role</span> <span class="ss">:accounts_department</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">generate_invoice</span>
      <span class="n">invoice</span> <span class="o">=</span>  <span class="no">Invoice</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">customer</span><span class="p">.</span><span class="nf">address</span><span class="p">,</span> <span class="n">selected_product</span><span class="p">.</span><span class="nf">invoice_desc</span><span class="p">,</span> <span class="n">total</span> <span class="p">)</span>
      <span class="n">invoices</span> <span class="o">&lt;&lt;</span> <span class="n">invoice</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>My first thought looking at this was “WTF?”  This is <em>entirely</em> too complex for the task at hand.  It looks like it would be hard
to write, hard to test, and hard to read (not to mention <a href="http://tonyarcieri.com/dci-in-ruby-is-completely-broken">hard to execute</a>).</p>

<p>Why?</p>

<p>Let’s start with the definition of <code class="highlighter-rouge">call</code>, and let’s assume that we understand that <code class="highlighter-rouge">in_context</code> runs the code inside our “DCI
Container” that enables the DSL.  This is a big assumption, but I’ll make it.  The first call:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">customer</span><span class="p">.</span><span class="nf">buy_product</span>
</code></pre>
</div>

<p>What is <code class="highlighter-rouge">customer</code>?  Where is it defined?  I see no method with that name.  I’ll need to understand that the hash given to
<code class="highlighter-rouge">assign_named_roles</code> renames the object given to the constructor.  OK, what about <code class="highlighter-rouge">buy_product</code>, the method that’s being called?</p>

<p>It’s not a method on <code class="highlighter-rouge">User</code>, so I’ll need to hunt down inside my class to find a definition, making sure to note if it is, or
is not, defined inside a <code class="highlighter-rouge">role :customer</code> block - presumably I could do <code class="highlighter-rouge">role :foobar</code> and define a method <code class="highlighter-rouge">buy_product</code> and that
would <em>not</em> be what I’m looking for.</p>

<p>Looking at that method, I see that it’s mutating an array called <code class="highlighter-rouge">purchases</code>, giving it the value of <code class="highlighter-rouge">selected_product</code>.
<code class="highlighter-rouge">purchases</code> is <em>not</em> a role, nor was it passed to <code class="highlighter-rouge">assign_named_roles</code>, so where is <em>it</em> coming from?</p>

<p>Turns out, it’s an attribute of <code class="highlighter-rouge">User</code> and that the method definition we are reading is being executed inside the binding of the <code class="highlighter-rouge">User</code> instance passed to the constructor.  Finally, we see that that <code class="highlighter-rouge">selected_product</code> <em>is</em> a role, an instance of <code class="highlighter-rouge">Product</code>.</p>

<p>One line down, one to go.  Whew!</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">accounts_department</span><span class="p">.</span><span class="nf">generate_invoice</span>
</code></pre>
</div>

<p>Again, we confirm that <code class="highlighter-rouge">accounts_department</code> is not a method defined locally, but is an instance of <code class="highlighter-rouge">Accounts</code> set up in the constructor. The method <code class="highlighter-rouge">generate_invoice</code> is a method defined at the bottom of our class presumably added to the <code class="highlighter-rouge">Accounts</code> instance by the DSL.  As before, <code class="highlighter-rouge">invoices</code> is an attribute of <code class="highlighter-rouge">Accounts</code>, and our method is executing inside that binding, which we just have to remember to piece together.</p>

<p>And this is for a <em>two line method</em> in a <em>very simplified domain</em>.  Exactly <strong>how</strong> is this supposed to make my job of reading
and writing code easier?!  And how the heck do we test all this?  <em>More</em> DSLs?</p>

<p>rebo states his case for this complexity and insanity by showing some “fat model” code as well as some unscoped “glue code” that
implements this use case.  This code is, indeed bad, too.  It puts logic on the models that really don’t belong there.  Can we do better?  Yes.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PurchasingProcess</span>
  <span class="k">def</span> <span class="nf">purchase_product</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span><span class="n">product</span><span class="p">,</span><span class="n">accounts</span><span class="p">)</span>
    <span class="n">customer</span><span class="p">.</span><span class="nf">purchases</span> <span class="o">&lt;&lt;</span> <span class="n">product</span>
    <span class="n">invoice_desc</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">invoice</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2"> - </span><span class="si">#{</span><span class="n">invoice</span><span class="p">.</span><span class="nf">description</span><span class="si">}</span><span class="s2"> @ </span><span class="si">#{</span><span class="n">invoice</span><span class="p">.</span><span class="nf">price</span><span class="si">}</span><span class="s2"> ea."</span>
    <span class="n">accounts</span><span class="p">.</span><span class="nf">invoices</span> <span class="o">&lt;&lt;</span> <span class="no">Invoice</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">customer</span><span class="p">.</span><span class="nf">address</span><span class="p">,</span><span class="n">invoice_desc</span><span class="p">,</span> <span class="n">invoice</span><span class="p">.</span><span class="nf">total</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Yup. Instead of bringing in a complex framework, confusing monkeypatching, and dynamic methods created in non-obvious bindings, I
just <em>made a class</em> that implements the <em>business logic</em>, and write the requisite three lines of code.</p>

<p>I didn’t have to change the core business objects, nor should I have - the format of <code class="highlighter-rouge">invoice_desc</code> is, so far, particular to
this use case, and needn’t be part of the <code class="highlighter-rouge">Invoice</code> class.  To understand this, we don’t need to leap too far: the <code class="highlighter-rouge">customer</code> is a
customer that we know contains <code class="highlighter-rouge">purchases</code>.  We add the passed <code class="highlighter-rouge">Purchase</code> instance, <code class="highlighter-rouge">purchases</code>, to that, then construct a
description of the invoice before adding a new invoice to the <code class="highlighter-rouge">accounts</code> instance we were given.</p>

<p>The method that implements our business logic is all based on parameters or local variables - there is no global or class-level
state to worry about, and each object is named for the type of class it is - no need to mentally translate when reading the code.
Assuming you understand what the core domain objects are, you can read and comprehend this entire business process on a VT100
terminal (if you had to).</p>

<p>If this business process needs to get more complex, we can use method extraction as a first step to fight complexity, and could
just <em>make more classes</em> if it gets worse. If it turns out that <em>another</em> business process needs to share some of this logic <em>by
design</em>, we can just apply <a href="http://www.naildrivin5.com/blog/2012/12/19/re-use-in-oo-inheritance.html">other methods of re-use</a> to deal with it then.</p>

<p>So, what is so wrong with this that we need some complex container to manage what should be just a few lines of code?  I do not
know.  I’m willing to concede this as a straw man argument, to a certain degree, but I’m still waiting to see how DCI is an
improvement over basic structured programming.</p>


  </section>
</article>
</div>

    </section>
  </main>
  <footer class="center">
    <p class="f6">
      Copyright &copy; 2006-2016, by David Bryant Copeland, All Rights Reserved
    </p>
  </footer>
  <script type="text/javascript">
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '56a22cd9c88d90284f000861');
      t.setAttribute('data-track-path', 'https://track.gaug.es/track.gif');
      t.src = 'https://d36ee2fcip1434.cloudfront.net/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  </script>
</body></html>
