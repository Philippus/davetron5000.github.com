
<!DOCTYPE html>
<html language="en"><head>
  <meta charset="utf-8">
  <title>Bad Programming in Java is Dangerous - naildrivin5.com - David Bryant Copeland's Website</title>
  <meta name="author" content="David Bryant Copeland">
  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/images/favicons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/images/favicons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/images/favicons/ms-icon-144x144.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  

  
  <meta name="description" content="

  
    Bad Programming in Java is Dangerous
    
      January 20, 2013
    
  
  
    Saw a blog post this morning titled Why Functional Program...">
  

  
  <link rel="canonical" href="http://naildrivin5.com/blog/2013/01/20/bad-programming-in-java-is-dangerous.html">
  <link href="/favicon.png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="naildrivin5.com - David Bryant Copeland's Website" type="application/atom+xml">
  <link href="/css/styles.css" rel="stylesheet">
  <script src="https://use.typekit.net/ylm4zpa.js"></script>
  <script>try{Typekit.load({ async: true });}catch(e){}</script>
            
  <meta name="google-site-verification" content="h_yTpXa6N3ebHj8DYmgX4lIFGHBW1NtGMVHfXuu7i_4" />
</head>
<body>
  <header class="site-header pb2 mb2 center">
    <h1 class="uc ls2 f1"><a href="/">naildrivin5.com</a></h1>
    <h2 class="ls1"><small class="uc h4">Website of</small> David Bryant Copeland</h2>
    <nav>
      <ul>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/">Blog</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/bio">About</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/books">Books</a></li>
        <li class="text-c w-1-3"><a class="ib w-100 button" href="/talks">Talks</a></li>
      </ul>
      <div style="clear: both"></div>
    </nav>
  </header>
  <main>
    <section>
      <div>
<article role="article" class="blog-post">
  <header class="border-bottom border-light">
    <h1>Bad Programming in Java is Dangerous</h1>
    <h2 class="f5 ls2 fw-bold mtnone uc ib">
      January 20, 2013
    </h2>
  </header>
  <section class="blog-content">
    <p>Saw a blog post this morning titled <a href="http://cafe.elharo.com/programming/java-programming/why-functional-programming-in-java-is-dangerous/">Why Functional Programming in Java is Dangerous</a>.  Author Elliotte Rusty Harold sets up
the world’s worst straw man I’ve seen.  He talks about <a href="http://pragprog.com/magazines/2013-01/functional-programming-basics">Uncle Bob’s post</a> on the advantages of functional programming.
Elliotte’s thesis is that Java and JVM just can’t handle this sort of thing, and then sets out to prove this with some terrible code that, unsurprisingly, is terrible.  He takes this bit of Clojure</p>

<p><code class="highlighter-rouge">clojure
(take 25 (squares-of (integers)))
</code></p>

<p>And “re-implements” it in Java.  He does this by implementing <code class="highlighter-rouge">integers</code> to just allocate an array of all the integers.</p>

<p>Yeah.</p>

<!-- more -->

<p>That’s bad enough, but really, that line of Clojure isn’t functional <em>per se</em>, it’s just that aspects of a functional programming
language (namely first-class functions and lazy evaluation) make it really easy to implement that code in an efficient way.</p>

<p>Elliotte is just flat wrong that you can’t do this in Java.  I will now present the Java version of the Clojure version.</p>

<h2 id="as-always-laziness-is-the-key-to-success">As always, laziness is the key to success</h2>

<p>The key to making it work is to use a lazy list which, in Java, is called <code class="highlighter-rouge">Iterator</code>.  If you have never used Java before,
<code class="highlighter-rouge">Iterator</code> is basically this:</p>

<p><code class="highlighter-rouge">java
public interface Iterator&lt;T&gt; {
  public boolean hasNext(); // true if there are more elements
  public T next();          // get the next element
  public void remove();     // remove the element you just got (optional)
}
</code></p>

<p>First, let’s make a list of all the integers.  The top of the collection food chain in Java is <code class="highlighter-rouge">Iterable</code>, which has one method
that just returns an <code class="highlighter-rouge">Iterator</code>.  We’ll make an <code class="highlighter-rouge">Iterator</code> of all the integers and wrap it up in an anonymous <code class="highlighter-rouge">Iterable</code> for use by anyone:</p>

<p>```java
private static class IntegersIterator implements Iterator<integer> {
  private int nextInt = 0;
  public boolean hasNext() {
    return nextInt &lt; Integer.MAX_VALUE;
  }
  public Integer next() {
    if (!hasNext()) {
      throw new NoSuchElementException();
    }
    nextInt++;
    return nextInt - 1;
  }
  public void remove() {
    throw new UnsupportedOperationException();
  }
}</integer></p>

<p>private static Iterable<integer> integers() {
  return new Iterable<integer>() {
    public Iterator<integer> iterator() {
      return new IntegersIterator();
    }
  };
}
```</integer></integer></integer></p>

<p>This is almost all there is to it.  To make the <code class="highlighter-rouge">squares-of</code> function, we need to maintain the “laziness” of our implementation.
To do this, we’ll create a squaring <code class="highlighter-rouge">Iterator</code> that proxies<a name="back-1"></a><sup><a href="#1">1</a></sup> through to another <code class="highlighter-rouge">Iterator</code>:</p>

<p>```java
private static class SquaringIterator implements Iterator<integer> {
  private Iterator<integer> original;
  public SquaringIterator(Iterator<integer> iter) {
    original = iter;
  }
  public boolean hasNext() {
    return original.hasNext();
  }
  public Integer next() {
    int value = original.next();
    return value * value;
  }
  public void remove() {
    original.remove();
  }
}</integer></integer></integer></p>

<p>private static Iterable<integer> squaresOf(final Iterable<integer> seq) {
  return new Iterable<integer>() {
    public Iterator<integer> iterator() {
      return new SquaringIterator(seq.iterator());
    }
  };
}
```</integer></integer></integer></integer></p>

<p>We <em>are</em> starting to see some of Java’s warts here.  Because we’re creating an anonymous inner class, that class cannot access
parameters or local variables unless we declare them <code class="highlighter-rouge">final</code> - we’ve declared the parameter to <code class="highlighter-rouge">squaresOf</code> as such.  This is because Java doesn’t support real closures.  We could’ve
made a class that implements <code class="highlighter-rouge">Iterable&lt;Integer&gt;</code> just for our <code class="highlighter-rouge">squaresOf</code> function, but that feels like overkill for this
increasingly contrived example.</p>

<p>OK, now that we have a way to get <em>all</em> the integers <em>and</em> square them without <em>actually instantiating</em> all the integers, we can
just take the first 25 off:</p>

<p>```java
public static void main(String args[]) {
  System.out.println(take(25,squaresOf(integers())));
}</p>

<p>private static List<integer> take(int numToTake, Iterable<integer> seq) {
  List<integer> results = new ArrayList<integer>();
  Iterator<integer> iterator = seq.iterator();
  for(int i=0;i&lt;numToTake;i++) {
    if (iterator.hasNext()) {
      results.add(iterator.next());
    }
  }
  return results;
}
```</integer></integer></integer></integer></integer></p>

<p>Running this code sure enough works quickly and without incident (full listing <a href="https://gist.github.com/4579317">here</a>):</p>

<p><code class="highlighter-rouge">
&gt; java -cp . Functional
[0, 1, 4, 9, 16, 25, 36, 49, 64, 81, 100, 121, 144, 169, 196, 225, 256, 289, 324, \
361, 400, 441, 484, 529, 576]
</code></p>

<p>So, it’s certainly possible to create lazy data structures in Java. There are a few things bad about this, however:</p>

<ul>
  <li>It’s very special purpose - if we needed a <code class="highlighter-rouge">doublesOf</code> or <code class="highlighter-rouge">squareRootsOf</code>, we’d create a lot of duplicate code</li>
  <li>It’s not very OO - we’d expect our code to be something like <code class="highlighter-rouge">squaresOf(integers).take(25)</code>.</li>
</ul>

<p>Let’s fix it!</p>

<h2 id="functions-to-the-rescue">Functions to the rescue</h2>

<p><em>Now</em> we’re going to need a <code class="highlighter-rouge">Function</code> interface:</p>

<p><code class="highlighter-rouge">java
private static interface Function1&lt;A,R&gt; {
  public R apply(A a);
}
</code></p>

<p>Think of <code class="highlighter-rouge">A</code> is “argument” and <code class="highlighter-rouge">R</code> as “return value”.</p>

<p>With this, we can genericize our <code class="highlighter-rouge">SquaringIterator</code> into a <code class="highlighter-rouge">TransformingIterator</code> that takes a function for transformation and
the <code class="highlighter-rouge">Iterator</code> to transform:</p>

<p>```
private static class TransformingIterator&lt;A,R&gt; implements Iterator<r> {
  private Iterator<a> original;
  private Function1&lt;A,R&gt; function;</a></r></p>

<p>public TransformingIterator(Function1&lt;A,R&gt; function, Iterator<a> iter) {
    this.original = iter;
    this.function = function;
  }
  public boolean hasNext() {
    return this.original.hasNext();
  }
  public R next() {
    A value = this.original.next();
    return this.function.apply(value);
  }
  public void remove() {
    original.remove();
  }
}
```</a></p>

<p><em>Now</em>, we can make our <code class="highlighter-rouge">squaresOf</code> method like so:</p>

<p><code class="highlighter-rouge">java
private static Iterable&lt;Integer&gt; squaresOf(final Iterable&lt;Integer&gt; seq) {
  return new Iterable&lt;Integer&gt;() {
    public Iterator&lt;Integer&gt; iterator() {
      Function1&lt;Integer,Integer&gt; square = new Function1&lt;Integer,Integer&gt;() {
        public Integer apply(Integer i) {
          return i * i;
        }
      };
      return new TransformingIterator&lt;Integer,Integer&gt;(square, seq.iterator());
    }
  };
}
</code></p>

<p>Using <code class="highlighter-rouge">TransformingIterator</code>, we could make a <code class="highlighter-rouge">doublesOf</code> method like so:</p>

<p><code class="highlighter-rouge">java
private static Iterable&lt;Integer&gt; doublesOf(final Iterable&lt;Integer&gt; seq) {
  return new Iterable&lt;Integer&gt;() {
    public Iterator&lt;Integer&gt; iterator() {
      Function1&lt;Integer,Integer&gt; square = new Function1&lt;Integer,Integer&gt;() {
        public Integer apply(Integer i) {
          return i + i;
        }
      };
      return new TransformingIterator&lt;Integer,Integer&gt;(square, seq.iterator());
    }
  };
}
</code></p>

<p>Yes, creating a function in Java is messy, but it’s not impossible, and doesn’t affect the runtime performance of our
application.  This ability to extract structure and code vs. logic is the true power of functional programming.</p>

<h2 id="making-it-more-oo">Making it more OO</h2>

<p>Now, what about that pesky <code class="highlighter-rouge">take</code> method?  We can handle that pretty easily by creating an implementation of <code class="highlighter-rouge">Iterable</code> that adds
the necessary methods:</p>

<p>```java
private abstract static class RichIterable<t> implements Iterable<t> {</t></t></p>

<p>public static <t> RichIterable<t> fromIterable(Iterable<t> seq) {
    return new ProxyRichIterable<t>(seq);
  }</t></t></t></t></p>

<p>public RichIterable<t> take(int numToTake) {
    List<t> results = new ArrayList<t>();
    Iterator<t> iterator = this.iterator();
    for(int i=0;i&lt;numToTake;i++) {
      if (iterator.hasNext()) {
        results.add(iterator.next());
      }
    }
    return fromIterable(results);
  }</t></t></t></t></p>

<p>public List<t> toList() {
    List<t> list = new ArrayList<t>();
    for(T t: this) {
      list.add(t);
    }
    return list;
  }
}</t></t></t></p>

<p>private static class ProxyRichIterable<t> extends RichIterable<t> {
  private Iterable<t> seq;
  public ProxyRichIterable(Iterable<t> seq) {
    this.seq = seq;
  }
  public Iterator<t> iterator() {
    return seq.iterator();
  }
}
```</t></t></t></t></t></p>

<p>Notice that we create a means of converting any <code class="highlighter-rouge">Iterable</code> (i.e. any Java collection) into our <code class="highlighter-rouge">RichIterable</code>, and also provide a
way to turn it back into a vanilla list.  We replace all use of <code class="highlighter-rouge">Iterable</code> in our code with <code class="highlighter-rouge">RichIterable</code> and our <code class="highlighter-rouge">main</code> method looks more “OO”:</p>

<p><code class="highlighter-rouge">java
public static void main(String args[]) {
  System.out.println(squaresOf(integers()).take(25).toList());
}
</code></p>

<p>And, it still runs great (updated source <a href="https://gist.github.com/4579399">here</a>):</p>

<p><code class="highlighter-rouge">
&gt; java -cp . Functional
[0, 1, 4, 9, 16, 25, 36, 49, 64, 81, 100, 121, 144, 169, 196, 225, 256, 289, 324, \
361, 400, 441, 484, 529, 576]
</code></p>

<p>So, what did we learn?  We learned that you can’t just write shitty code in Java and then say Java and the JVM can’t handle
functional programming.  Java can <em>absolutely</em> handle functional programming, even though Java’s syntax makes it a bit painful.</p>

<hr />

<footer class="footnotes">
<ol>
<li>
<a name="1"></a>
<sup>1</sup>See how I used the name of a design pattern instead of painfully explaining to you what a proxy is?  Handy, isn't it?<a href="#back-1">↩</a>
</li>
</ol></footer>

  </section>
</article>
</div>

    </section>
  </main>
  <footer class="center">
    <p class="f6">
      Copyright &copy; 2006-2016, by David Bryant Copeland, All Rights Reserved
    </p>
  </footer>
  <script type="text/javascript">
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '56a22cd9c88d90284f000861');
      t.setAttribute('data-track-path', 'https://track.gaug.es/track.gif');
      t.src = 'https://d36ee2fcip1434.cloudfront.net/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  </script>
</body></html>
